<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORION - Organiza. Evoluciona. Expande tu universo.</title>
    <!-- Favicon - Versi√≥n completa para PWA -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <meta name="theme-color" content="#6366F1">
    
    <!-- Resource Hints para optimizaci√≥n -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Critical CSS inlined para fastest rendering -->
    <style>
        /* Critical path styles - inlined para evitar render-blocking */
        .skeleton { animation: skeleton-loading 1.2s ease-in-out infinite alternate; }
        @keyframes skeleton-loading { 0% { opacity: 1; } 100% { opacity: 0.4; } }
        .transition-fast { transition: all 0.15s ease; }
        body { font-family: Inter, system-ui, sans-serif; }
        .bg-theme { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
    
    <!-- Tailwind CSS - Solo en desarrollo, en producci√≥n usar build optimizado -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    
    <!-- Fonts con display=swap para mejor performance -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <!-- Resource Optimizer - Carga temprana -->
    <script type="module" src="/src/utils/resource-optimizer.js"></script>
    
    <!-- Bundle Manager - Sistema de bundles inteligente -->
    <script type="module" src="/src/utils/bundle-manager.js"></script>
    
    <!-- Sistema de carga inteligente de bundles -->
    <script>
        // Definir IS_DEV globalmente para acceso temprano
        window.IS_DEV = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';
        
        // Sistema de carga optimizada de recursos
        window.lazyLoadResources = async function() {
            try {
                // Cargar solo recursos cr√≠ticos inicialmente
                if (window.bundleManager) {
                    await window.bundleManager.autoLoad();
                    window.bundleManager.setupIntelligentPreloading();
                } else {
                    // Fallback para carga directa en caso de error
                if (window.IS_DEV) {
                    Logger.warn('Bundle manager not available, loading resources directly');
                }
                    await loadCriticalResourcesFallback();
                }
            } catch (error) {
                Logger.error('Error loading resources:', error);
                await loadCriticalResourcesFallback();
            }
        };
        
        // Fallback para carga directa (ya no necesario para m√≥dulos ES6)
        async function loadCriticalResourcesFallback() {
            // Los recursos cr√≠ticos ya se cargan como m√≥dulos ES6 arriba
            // Solo necesitamos cargar recursos externos aqu√≠ si es necesario
            if (window.IS_DEV) {
            if (window.IS_DEV) {
                Logger.info('Critical ES6 modules already loaded via import statements');
            }
            }
        }
        
        // Preload de recursos cr√≠ticos (solo para scripts no-module)
        function preloadCritical() {
            const criticalResources = [
                // Los m√≥dulos ES6 se cargan a trav√©s de import, no necesitan preload
                // Solo precargar recursos de terceros o scripts tradicionales
            ];
            
            criticalResources.forEach(href => {
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = 'script';
                link.href = href;
                document.head.appendChild(link);
            });
            
            if (window.IS_DEV) {
                // Logger no disponible a√∫n en preload
                console.log('üì¶ Module preload configured for non-ES6 resources');
            }
        }
        
        // Ejecutar preload inmediatamente
        preloadCritical();
        
        // Sistema de carga optimizada con bundles (reemplaza la funci√≥n anterior)
        window.lazyLoadResources = async function() {
            try {
                // Si ResourceOptimizer est√° disponible, usar carga inteligente
                if (window.resourceOptimizer) {
                    // Cargar Feather Icons con prioridad media
                    await window.resourceOptimizer.lazyLoad(
                        'https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js',
                        { priority: 'medium', defer: true }
                    );
                    
                    // Cargar SortableJS con prioridad baja
                    await window.resourceOptimizer.lazyLoad(
                        'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js',
                        { priority: 'low', defer: true }
                    );
                    
                    // Inicializar Feather despu√©s de cargar
                    if (window.feather) {
                        feather.replace();
                        window.dispatchEvent(new CustomEvent('featherReady'));
                        if (window.IS_DEV) {
                        if (window.IS_DEV) {
                            Logger.success('External resources loaded via ResourceOptimizer');
                        }
                        }
                    }
                    
                } else {
                    // Fallback a carga tradicional
                    await loadExternalResourcesFallback();
                }
                
            } catch (error) {
                Logger.warn('Error in optimized loading, falling back:', error);
                await loadExternalResourcesFallback();
            }
        };
        
        // Fallback para recursos externos
        async function loadExternalResourcesFallback() {
            const resources = [
                {
                    url: 'https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js',
                    callback: () => {
                        if (window.feather) {
                            feather.replace();
                            window.dispatchEvent(new CustomEvent('featherReady'));
                        }
                    }
                },
                {
                    url: 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js',
                    callback: null
                }
            ];
            
            for (const resource of resources) {
                try {
                    await loadExternalScript(resource.url, resource.callback);
                } catch (error) {
                    console.warn(`Failed to load ${resource.url}:`, error);
                }
            }
        }
        
        // Utilidad para cargar scripts externos
        function loadExternalScript(src, callback) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.defer = true;
                script.onload = () => {
                    if (callback) callback();
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Cargar cuando se transite a la app principal
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(window.lazyLoadResources, 2000); // Cargar despu√©s de 2 segundos
        });
    </script>

    <!-- ‚ú® CSS CR√çTICO INLINE - Elimina Flash of Unstyled Content (FOUC) -->
    <style>
        /* Reset b√°sico para evitar flash */
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden; /* Evita scroll durante carga */
        }

        /* Estado de carga inicial - Oculta todo hasta estar listo */
        .page-loading #welcome-screen,
        .page-loading #login-screen,
        .page-loading #main-app {
            display: none !important;
        }

        /* Loading screen elegante */
        .page-loading::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #110F1A 0%, #1E1B2E 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-loading::after {
            content: 'ORION';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #C084FC;
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 0.2em;
            z-index: 10000;
            opacity: 0.8;
        }

        /* Estados espec√≠ficos de pantallas - Definidos inline para garant√≠a */
        #welcome-screen { 
            display: flex; 
        }
        
        #login-screen.hidden { 
            display: none !important; 
        }
        
        #main-app.hidden { 
            display: none !important; 
        }

        /* Auth loading overrides - Refuerzo de especificidad */
        .auth-loading #welcome-screen { 
            display: none !important; 
        }
        
        .auth-loading #login-screen { 
            display: none !important; 
        }
        
        .auth-loading #main-app { 
            display: flex !important; 
            opacity: 1 !important; 
        }

        /* Animaci√≥n sutil para el loading */
        .page-loading::after {
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }
    </style>

    <style>
        /* Estilos base y configuraci√≥n de temas con Tailwind */
        :root {
            /* Tema Claro (Light) */
            --bg-light: #F4E9E0; /* Beige */
            --text-light: #4A4A4A;
            --primary-light: #E57373; /* Coral */
            --primary-light-rgb: 229, 115, 115;
            --secondary-light: #A5D6A7; /* Verde Seco */
            --accent-light: #FFB74D; /* Naranja Terracota */
            --card-light: #FFFFFF;
            --border-light: #E0D8D3; /* Un beige m√°s oscuro para el borde */
            
            /* Tema Oscuro (Dark) */
            --bg-dark: #110F1A; /* Azul Noche profundo */
            --text-dark: #E0E0E0;
            --primary-dark: #C084FC; /* Violeta */
            --primary-dark-rgb: 192, 132, 252;
            --secondary-dark: #F472B6; /* Magenta */
            --accent-dark: #FBBF24; /* Dorado suave */
            --card-dark: #1E1B2E;
            --border-dark: #3A3356;
        }

        /* ‚ú® PREVENCI√ìN DE FLASH DE PANTALLA DE BIENVENIDA */
        .auth-loading #welcome-screen {
            display: none !important;
        }
        
        .auth-loading #main-app {
            display: flex !important;
            opacity: 1 !important;
        }        /* Aplicaci√≥n de temas */
        .light {
            background-color: transparent; /* Fondo principal ahora es transparente */
            color: var(--text-light);
        }
        .dark {
            background-color: transparent; /* Fondo principal ahora es transparente */
            color: var(--text-dark);
        }

        /* Clases de utilidad para temas */
        .bg-theme { background-color: var(--bg-light); }
        .dark .bg-theme { background-color: var(--bg-dark); }
        .text-theme-primary { color: var(--primary-light); }
        .dark .text-theme-primary { color: var(--primary-dark); }
        .bg-theme-primary { background-color: var(--primary-light); }
        .dark .bg-theme-primary { background-color: var(--primary-dark); }
        .bg-theme-secondary { background-color: var(--secondary-light); }
        .dark .bg-theme-secondary { background-color: var(--secondary-dark); }
        .bg-theme-accent { background-color: var(--accent-light); }
        .dark .bg-theme-accent { background-color: var(--accent-dark); }
        .bg-theme-card { background-color: var(--card-light); }
        .dark .bg-theme-card { background-color: var(--card-dark); }
        .border-theme { border-color: var(--border-light); }
        .dark .border-theme { border-color: var(--border-dark); }
        
        /* Tipograf√≠as */
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
        
        /* Efecto typewriter (solo el cursor) */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--accent-dark); }
        }
        .typewriter-caret {
            border-right: .12em solid var(--accent-dark);
            animation: blink-caret .75s step-end infinite;
        }
        .light .typewriter-caret {
            border-right-color: var(--accent-light);
        }

        /* Estilos para SortableJS */
        .kanban-column .sortable-ghost {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            border: 2px dashed var(--accent-dark);
        }
        .light .kanban-column .sortable-ghost {
            border: 2px dashed var(--accent-light);
        }
        .task-card {
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        
        /* Mejora para el date picker en modo oscuro */
        .dark input[type="date"] {
            color-scheme: dark;
        }

        /* Estilo para spinner de carga */
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-dark) 25%, rgba(255,255,255,0.1) 50%, var(--bg-dark) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 12px;
            border-radius: 4px;
            margin: 4px 0;
        }
        
        .skeleton-title {
            height: 16px;
            border-radius: 4px;
            margin: 8px 0;
        }
        
        .skeleton-card {
            height: 80px;
            border-radius: 8px;
            margin: 8px 0;
        }

        /* PWA & Offline Styles */
        .offline .header-content::after {
            content: " (Offline)";
            color: #ef4444;
            font-size: 0.8em;
        }

        .pwa-mode {
            --header-height: 0px; /* No browser bars */
        }

        .pwa-mode .header {
            padding-top: env(safe-area-inset-top);
        }

        /* Service Worker Update Notification */
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sw-notification {
            animation: slideInFromRight 0.3s ease-out;
        }

        /* Offline indicator pulse */
        #offline-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Cache status indicator */
        .cache-healthy {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        /* Estilos para el Canvas del fondo de estrellas */
        #starfield-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Detr√°s de todo */
        }
        
        /* Animaciones de bienvenida */
        @keyframes star-glow-in {
            from {
                opacity: 0;
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
                transform: translateY(0);
            }
        }
        
        #welcome-screen h1 span {
            opacity: 0;
            animation: star-glow-in 0.8s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        #welcome-screen #slogan, #welcome-screen #start-btn, #welcome-screen footer {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Animaci√≥n para el punto de notificaci√≥n */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }
        }
        .notification-dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background-color: var(--accent-dark);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .light .notification-dot {
            background-color: var(--accent-light);
        }
    </style>
</head>
<body class="page-loading transition-colors duration-500 bg-theme">
    
    <canvas id="starfield-canvas"></canvas>

    <!-- PANTALLA DE BIENVENIDA -->
    <div id="welcome-screen" class="h-screen w-screen flex flex-col items-center justify-center text-center p-4 bg-transparent transition-opacity duration-1000">
        <div class="flex-grow flex flex-col items-center justify-center">
            <h1 id="main-title" class="text-7xl md:text-9xl font-bold text-white tracking-wider font-display">
                <!-- Las letras se insertar√°n aqu√≠ con JS -->
            </h1>
            <p id="slogan" class="text-lg md:text-xl mt-4 text-gray-300 h-16 md:h-8 flex items-center justify-center"></p>
            <button id="start-btn" class="mt-8 px-8 py-4 bg-theme-primary text-white font-bold rounded-full text-lg hover:scale-105 transform transition-transform duration-300 shadow-lg shadow-purple-500/50">
                Comenzar
            </button>
        </div>
        <footer class="pb-4">
            <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-400 opacity-75 hover:opacity-100 transition-opacity">
                Neptune Studios
            </a>
        </footer>
    </div>

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" class="hidden opacity-0 h-screen w-screen flex flex-col items-center justify-center text-center p-4 bg-transparent transition-opacity duration-1000">
        <div class="flex-grow flex flex-col items-center justify-center max-w-md w-full">
            <!-- Logo/T√≠tulo -->
            <div class="mb-8">
                <h1 class="text-4xl md:text-6xl font-bold text-white tracking-wider font-display mb-2">ORION</h1>
                <p class="text-gray-300 text-lg">Elige c√≥mo continuar</p>
            </div>

            <!-- Opciones de login -->
            <div class="w-full space-y-4">
                <!-- Bot√≥n de Google -->
                <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-white text-gray-800 font-semibold rounded-lg hover:bg-gray-100 transition-colors duration-300 shadow-lg">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continuar con Google
                </button>

                <!-- Separador -->
                <div class="flex items-center gap-4 my-6">
                    <div class="flex-1 h-px bg-gray-600"></div>
                    <span class="text-gray-400 text-sm">o</span>
                    <div class="flex-1 h-px bg-gray-600"></div>
                </div>

                <!-- Bot√≥n de invitado -->
                <button id="guest-signin-btn" class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-theme-secondary/20 text-white font-semibold rounded-lg hover:bg-theme-secondary/30 transition-colors duration-300 border border-theme-secondary/40">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                    </svg>
                    Continuar como Invitado
                </button>
            </div>

            <!-- Informaci√≥n adicional -->
            <div class="mt-8 text-sm text-gray-400 space-y-2">
                <p><strong>Con Google:</strong> Sincronizaci√≥n en la nube, acceso desde cualquier dispositivo</p>
                <p><strong>Como Invitado:</strong> Datos guardados localmente en este dispositivo</p>
            </div>

            <!-- Bot√≥n de volver -->
            <button id="back-to-welcome-btn" class="mt-6 text-gray-400 hover:text-white transition-colors underline">
                ‚Üê Volver
            </button>
        </div>

        <!-- Indicador de carga -->
        <div id="login-loading" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-theme-card p-6 rounded-lg flex items-center gap-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-theme-primary"></div>
                <span class="text-white">Iniciando sesi√≥n...</span>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL DE LA APP -->
    <div id="main-app" class="hidden opacity-0 transition-opacity duration-1000 flex">
        
        <!-- NAVEGACI√ìN LATERAL (DOCK EN PC) -->
        <nav id="main-nav" class="hidden md:flex flex-col items-center w-20 bg-theme-card/10 border-r border-theme p-4">
            <div class="font-display text-2xl font-bold text-theme-primary">O</div>
            <div class="space-y-6 mt-6">
                <button data-section="dashboard" class="nav-btn relative p-3 rounded-lg bg-theme-primary text-white"><i data-feather="home"></i></button>
                <button data-section="tasks" class="nav-btn p-3 rounded-lg"><i data-feather="check-square"></i></button>
                <button data-section="calendar" class="nav-btn p-3 rounded-lg"><i data-feather="calendar"></i></button>
                <button data-section="kaizen" class="nav-btn p-3 rounded-lg"><i data-feather="zap"></i></button>
                <button data-section="settings" class="nav-btn p-3 rounded-lg"><i data-feather="settings"></i></button>
            </div>
            <div class="mt-auto">
                 <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 opacity-75 hover:opacity-100 transition-opacity">
                    NS
                </a>
            </div>
        </nav>

        <!-- NAVEGACI√ìN SUPERIOR (MOBILE) -->
        <nav id="mobile-nav" class="md:hidden fixed top-0 left-0 right-0 bg-theme-card/80 backdrop-blur-sm border-b border-theme z-40 flex justify-between items-center p-4">
            <div class="font-display text-2xl font-bold text-theme-primary">ORION</div>
            <button id="hamburger-btn" class="p-2"><i data-feather="menu"></i></button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden fixed inset-0 bg-theme/90 backdrop-blur-lg z-50 flex flex-col items-center justify-center">
             <button id="close-mobile-menu" class="absolute top-6 right-6 p-2"><i data-feather="x"></i></button>
             <div class="flex flex-col items-center justify-center flex-grow space-y-8">
                <button data-section="dashboard" class="mobile-nav-btn relative text-2xl">Dashboard</button>
                <button data-section="tasks" class="mobile-nav-btn text-2xl">Tareas</button>
                <button data-section="calendar" class="mobile-nav-btn text-2xl">Calendario</button>
                <button data-section="kaizen" class="mobile-nav-btn text-2xl">Kaizen</button>
                <button data-section="settings" class="mobile-nav-btn text-2xl">Configuraci√≥n</button>
             </div>
             <footer class="pb-8">
                <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-400 opacity-75 hover:opacity-100 transition-opacity">
                    Neptune Studios
                </a>
             </footer>
        </div>

        <!-- CONTENEDOR DE SECCIONES -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto h-screen mt-16 md:mt-0 pb-24 md:pb-8 bg-theme/80 dark:bg-theme/90 backdrop-blur-sm">
            
            <!-- DASHBOARD -->
            <section id="dashboard" class="app-section">
                <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                    Hola, <span id="user-name"></span>
                    <div id="connection-status" class="flex items-center gap-1 text-sm font-normal">
                        <div id="status-indicator" class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span id="status-text" class="text-gray-500">En l√≠nea</span>
                    </div>
                </h2>
                <p class="text-lg text-gray-400 mb-8">¬øQu√© vas a mejorar hoy?</p>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 flex flex-col gap-8">
                        <!-- Tareas para Hoy -->
                        <div id="dashboard-today" class="bg-theme-card p-6 rounded-xl shadow-lg border-2 border-theme-primary order-1">
                            <h3 class="text-2xl font-bold mb-4">Tareas para Hoy</h3>
                            <div id="today-tasks-list" class="space-y-3"></div>
                        </div>
                        <!-- Resumen de Proyectos -->
                        <div id="dashboard-projects" class="bg-theme-card p-6 rounded-xl shadow-lg order-3 lg:order-2">
                            <h3 class="text-2xl font-bold mb-4">Resumen de Proyectos</h3>
                            <div id="project-summary-list" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-8">
                         <!-- Pr√≥ximas Tareas -->
                        <div id="dashboard-upcoming" class="bg-theme-card p-6 rounded-xl shadow-lg order-2 lg:order-1">
                            <h3 class="text-xl font-bold mb-4">Pr√≥ximas Tareas</h3>
                            <div id="upcoming-tasks-list" class="space-y-3"></div>
                        </div>
                        <!-- Racha de Productividad -->
                        <div id="dashboard-streak" class="bg-theme-card p-6 rounded-xl shadow-lg flex flex-col items-center justify-center text-center order-4 lg:order-2">
                            <i data-feather="award" class="w-12 h-12 text-theme-accent mb-2"></i>
                            <p class="text-5xl font-bold" id="streak-count">0</p>
                            <p class="text-gray-400">D√≠as de racha</p>
                            <p class="text-xs text-gray-500 mt-4">Completa al menos una tarea cada d√≠a para mantener tu racha.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAREAS -->
            <section id="tasks" class="app-section hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold">Tareas y Proyectos</h2>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <button id="quick-save-btn" title="Guardar mis datos (Exportar JSON)" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity flex-shrink-0"><i data-feather="save" class="inline-block -mt-1"></i></button>
                        <button id="create-project-btn" title="Crear nuevo proyecto" class="bg-theme-secondary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity flex-shrink-0"><i data-feather="folder-plus" class="inline-block -mt-1"></i></button>
                        <button id="create-task-btn" title="Crear nueva tarea" class="bg-theme-primary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity flex-shrink-0"><i data-feather="plus" class="inline-block -mt-1"></i> Crear Tarea</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-4">
                    <div class="relative w-full md:max-w-xs">
                        <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        <input type="text" id="search-tasks-input" placeholder="Buscar tareas..." class="w-full bg-theme-card/50 border border-theme rounded-lg p-2 pl-10 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                    </div>
                    <select id="project-filter-select" class="w-full md:w-auto bg-theme-card/50 border border-theme rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                        <option value="all">Todos los proyectos</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Columnas Kanban - Layout responsive -->
                    
                    <!-- Desktop: Columnas tradicionales -->
                    <div class="hidden md:block kanban-column bg-theme-card/50 p-4 rounded-lg">
                        <h3 class="font-bold mb-4 text-yellow-400">üü° Por Hacer</h3>
                        <div id="todo-column" class="min-h-[200px] space-y-4"></div>
                    </div>
                    <div class="hidden md:block kanban-column bg-theme-card/50 p-4 rounded-lg">
                        <h3 class="font-bold mb-4 text-blue-400">üîµ En Progreso</h3>
                        <div id="doing-column" class="min-h-[200px] space-y-4"></div>
                    </div>
                    <div class="hidden md:block kanban-column bg-theme-card/50 p-4 rounded-lg">
                        <h3 class="font-bold mb-4 text-green-400">‚úÖ Completadas</h3>
                        <div id="completed-column" class="min-h-[200px] space-y-4"></div>
                    </div>
                    
                    <!-- Mobile: Modales plegables -->
                    <div class="md:hidden col-span-full space-y-4">
                        <!-- Modal Por Hacer -->
                        <div class="mobile-task-modal bg-theme-card/50 rounded-lg overflow-hidden">
                            <div class="mobile-task-header flex justify-between items-center p-4 cursor-pointer" data-section="todo">
                                <h3 class="font-bold text-yellow-400 flex items-center">
                                    üü° Por Hacer 
                                    <span class="ml-2 text-sm bg-yellow-400/20 text-yellow-400 px-2 py-1 rounded-full" id="todo-count">0</span>
                                </h3>
                                <i data-feather="chevron-down" class="mobile-chevron transition-transform duration-200"></i>
                            </div>
                            <div class="mobile-task-content hidden">
                                <div id="mobile-todo-column" class="p-4 pt-0 space-y-3"></div>
                            </div>
                        </div>
                        
                        <!-- Modal En Progreso -->
                        <div class="mobile-task-modal bg-theme-card/50 rounded-lg overflow-hidden">
                            <div class="mobile-task-header flex justify-between items-center p-4 cursor-pointer" data-section="doing">
                                <h3 class="font-bold text-blue-400 flex items-center">
                                    üîµ En Progreso 
                                    <span class="ml-2 text-sm bg-blue-400/20 text-blue-400 px-2 py-1 rounded-full" id="doing-count">0</span>
                                </h3>
                                <i data-feather="chevron-down" class="mobile-chevron transition-transform duration-200"></i>
                            </div>
                            <div class="mobile-task-content hidden">
                                <div id="mobile-doing-column" class="p-4 pt-0 space-y-3"></div>
                            </div>
                        </div>
                        
                        <!-- Modal Completadas -->
                        <div class="mobile-task-modal bg-theme-card/50 rounded-lg overflow-hidden">
                            <div class="mobile-task-header flex justify-between items-center p-4 cursor-pointer" data-section="completed">
                                <h3 class="font-bold text-green-400 flex items-center">
                                    ‚úÖ Completadas 
                                    <span class="ml-2 text-sm bg-green-400/20 text-green-400 px-2 py-1 rounded-full" id="completed-count">0</span>
                                </h3>
                                <i data-feather="chevron-down" class="mobile-chevron transition-transform duration-200"></i>
                            </div>
                            <div class="mobile-task-content hidden">
                                <div id="mobile-completed-column" class="p-4 pt-0 space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CALENDARIO -->
            <section id="calendar" class="app-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Calendario</h2>
                    <button id="goto-today-btn" class="bg-theme-primary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity">Ir a Hoy</button>
                </div>
                <div class="bg-theme-card p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-theme-card"><i data-feather="chevron-left"></i></button>
                        <h3 id="month-year-header" class="text-xl font-bold"></h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-theme-card"><i data-feather="chevron-right"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 border-r border-b border-theme">
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">D</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">L</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">M</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">M</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">J</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">V</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">S</div>
                    </div>
                </div>
            </section>

            <!-- KAIZEN -->
            <section id="kaizen" class="app-section hidden max-w-4xl mx-auto">
                <h2 class="text-4xl font-bold text-center mb-4 font-display text-theme-primary">El Camino Kaizen</h2>
                <p class="text-center text-lg text-gray-400 mb-12">Mejora continua, un peque√±o paso a la vez.</p>
                <div class="space-y-8">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="bg-theme-card p-6 rounded-full text-theme-primary"><i data-feather="target" class="w-10 h-10"></i></div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">¬øQu√© es el m√©todo Kaizen?</h3>
                            <p>Kaizen es una filosof√≠a japonesa que se centra en la mejora continua en todos los aspectos de la vida. En lugar de buscar cambios radicales y abruptos, Kaizen propone realizar peque√±as mejoras incrementales de forma constante.</p>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row-reverse items-center gap-6">
                        <div class="bg-theme-card p-6 rounded-full text-theme-primary"><i data-feather="bar-chart-2" class="w-10 h-10"></i></div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">¬øC√≥mo mejora tu productividad?</h3>
                            <p>Al dividir grandes metas en tareas min√∫sculas (microacciones), se reduce la procrastinaci√≥n y el agobio. Cada peque√±a victoria genera momentum y motivaci√≥n, creando un ciclo positivo de progreso que, con el tiempo, conduce a resultados extraordinarios.</p>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="bg-theme-card p-6 rounded-full text-theme-primary"><i data-feather="play-circle" class="w-10 h-10"></i></div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">Aplica microacciones en ORION</h3>
                            <p>Usa la secci√≥n de Tareas para crear acciones que te tomen menos de 5 minutos. ¬øQuieres leer un libro? Crea una tarea "Leer una p√°gina". ¬øQuieres aprender a programar? "Ver 2 minutos de un tutorial". La clave es la consistencia.</p>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-12">
                    <button id="try-kaizen-btn" class="bg-theme-primary text-white px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transform transition-transform duration-300">Probar ahora</button>
                </div>
            </section>

            <!-- CONFIGURACI√ìN -->
            <section id="settings" class="app-section hidden max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold mb-8">Configuraci√≥n</h2>
                <div class="space-y-6">
                    <!-- Tema -->
                    <div class="bg-theme-card p-4 rounded-lg">
                        <h3 class="font-bold mb-3">Tema de la Interfaz</h3>
                        <div class="flex items-center space-x-4">
                            <span>Claro</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="theme-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-theme-primary"></div>
                            </label>
                            <span>Oscuro</span>
                        </div>
                    </div>
                    <!-- Perfil -->
                    <div class="bg-theme-card p-4 rounded-lg">
                        <h3 class="font-bold mb-3">Perfil de Usuario</h3>
                        <label for="username-input" class="block text-sm text-gray-400">Nombre de usuario</label>
                        <input type="text" id="username-input" class="w-full bg-theme/50 border border-theme rounded-md p-2 mt-1 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                    </div>
                    <!-- Datos -->
                    <div class="bg-theme-card p-4 rounded-lg">
                        <h3 class="font-bold mb-3">Gesti√≥n de Datos</h3>
                        <div class="flex flex-col md:flex-row gap-3 mb-3">
                            <button id="export-json-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Guardar mis datos</button>
                            <label class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors text-center cursor-pointer">
                                <span>Cargar mis datos</span>
                                <input type="file" id="import-json-input" class="hidden" accept=".json">
                            </label>
                        </div>
                        <button id="storage-stats-btn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">üìä Ver Estad√≠sticas</button>
                    </div>
                     <!-- Zona de peligro -->
                    <div class="border-2 border-red-500/50 p-4 rounded-lg mt-8">
                        <h3 class="font-bold text-red-400 mb-3">Zona de Peligro</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button id="logout-btn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors">Cerrar Sesi√≥n</button>
                            <button id="delete-all-btn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">‚ö†Ô∏è Borrar Todo</button>
                        </div>
                    </div>
                </div>
                 <footer class="mt-12 text-center">
                    <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 opacity-75 hover:opacity-100 transition-opacity">
                        Neptune Studios
                    </a>
                </footer>
            </section>

        </main>
    </div>

    <!-- MODALES -->
    <div id="modal-container">
        <!-- Modal para Tareas -->
        <div id="task-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-md transform transition-all opacity-0 -translate-y-10" role="dialog" aria-modal="true">
                <h3 id="modal-title" class="text-2xl font-bold mb-6">Crear Nueva Tarea</h3>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="mb-4">
                        <label for="task-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre de la tarea</label>
                        <input type="text" id="task-name" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400" required>
                    </div>
                    <div class="mb-4">
                        <label for="task-project" class="block text-sm font-medium text-gray-400 mb-1">Proyecto</label>
                        <select id="task-project" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                           <option value="none">Sin proyecto</option>
                        </select>
                    </div>
                     <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Prioridad</label>
                        <div class="flex justify-around p-1 bg-theme/50 rounded-md border border-theme">
                           <label class="flex-1 text-center cursor-pointer p-1 rounded-md transition-colors"><input type="radio" name="priority" value="low" class="sr-only peer"><span class="peer-checked:bg-green-500 peer-checked:text-white px-2 py-1 rounded-md">Baja</span></label>
                           <label class="flex-1 text-center cursor-pointer p-1 rounded-md transition-colors"><input type="radio" name="priority" value="medium" class="sr-only peer" checked><span class="peer-checked:bg-yellow-500 peer-checked:text-white px-2 py-1 rounded-md">Media</span></label>
                           <label class="flex-1 text-center cursor-pointer p-1 rounded-md transition-colors"><input type="radio" name="priority" value="high" class="sr-only peer"><span class="peer-checked:bg-red-500 peer-checked:text-white px-2 py-1 rounded-md">Alta</span></label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="task-description" class="block text-sm font-medium text-gray-400 mb-1">Descripci√≥n</label>
                        <textarea id="task-description" rows="3" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="task-date" class="block text-sm font-medium text-gray-400 mb-1">Fecha</label>
                        <input type="date" id="task-date" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                    </div>
                    <div class="flex items-center mb-6">
                        <input id="task-calendar-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-theme-primary focus:ring-theme-primary">
                        <label for="task-calendar-checkbox" class="ml-2 block text-sm">Agregar al calendario</label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-task-btn" class="px-4 py-2 rounded-md text-gray-400 hover:bg-gray-700">Cancelar</button>
                        <button type="submit" id="save-task-btn" class="px-6 py-2 bg-theme-primary text-white rounded-md font-semibold flex items-center justify-center min-w-[80px]">Crear</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal para Proyectos -->
        <div id="project-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-md transform transition-all opacity-0 -translate-y-10" role="dialog" aria-modal="true">
                <h3 class="text-2xl font-bold mb-6">Crear Nuevo Proyecto</h3>
                <form id="project-form">
                    <div class="mb-6">
                        <label for="project-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre del proyecto</label>
                        <input type="text" id="project-name" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400" required>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-project-btn" class="px-4 py-2 rounded-md text-gray-400 hover:bg-gray-700">Cancelar</button>
                        <button type="submit" id="save-project-btn" class="px-6 py-2 bg-theme-primary text-white rounded-md font-semibold flex items-center justify-center min-w-[80px]">Crear</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Simple para Tareas del Calendario (M√≥vil) -->
        <div id="calendar-day-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50">
            <!-- Versi√≥n M√≥vil -->
            <div class="mobile-calendar-modal md:hidden w-full h-full flex flex-col">
                <!-- Header -->
                <div class="bg-theme-card p-4 border-b border-theme">
                    <div class="flex items-center justify-between">
                        <h3 id="mobile-calendar-title" class="text-lg font-bold text-theme-primary">
                            <!-- Fecha se actualizar√° aqu√≠ -->
                        </h3>
                        <button type="button" id="close-mobile-calendar" class="p-2 rounded-full hover:bg-theme/10">
                            <i data-feather="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Contenido -->
                <div class="flex-1 bg-theme-card p-4 overflow-y-auto">
                    <div id="mobile-calendar-tasks">
                        <!-- Las tareas se mostrar√°n aqu√≠ -->
                    </div>
                </div>
            </div>
            
            <!-- Versi√≥n Desktop (Modal centrado tradicional) -->
            <div class="desktop-calendar-modal hidden md:flex items-center justify-center p-4 w-full h-full">
                <div class="bg-theme-card rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-6 border-b border-theme">
                        <button type="button" id="prev-day-btn" class="p-2 rounded-full hover:bg-theme/10">
                            <i data-feather="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <div id="desktop-calendar-title" class="flex-1 text-center">
                            <!-- Fecha se actualizar√° aqu√≠ -->
                        </div>
                        <button type="button" id="next-day-btn" class="p-2 rounded-full hover:bg-theme/10">
                            <i data-feather="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Contenido -->
                    <div class="p-6 flex-1 overflow-hidden">
                        <div id="desktop-calendar-tasks" class="space-y-3 max-h-full overflow-y-auto">
                            <!-- Las tareas se mostrar√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="flex justify-between items-center p-6 border-t border-theme">
                        <button type="button" id="add-task-from-calendar-btn" class="px-4 py-2 bg-theme-primary text-white rounded-lg">
                            <i data-feather="plus" class="w-4 h-4 inline mr-2"></i>
                            A√±adir Tarea
                        </button>
                        <button type="button" id="close-desktop-calendar" class="px-4 py-2 bg-gray-500 text-white rounded-lg">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estilos CSS para mejores animaciones -->
        <style>
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(156, 163, 175, 0.3);
                border-radius: 3px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(156, 163, 175, 0.5);
            }
            
            /* Animaci√≥n de entrada para las tareas */
            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .task-card-animate {
                animation: slideInUp 0.3s ease-out forwards;
            }
            
            /* Efectos hover mejorados */
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            
            /* Pulso para indicadores */
            @keyframes pulse-glow {
                0%, 100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.1);
                }
            }
            
            .pulse-glow {
                animation: pulse-glow 2s infinite;
            }
            
            /* ‚ú® FASE 2: Animaciones y micro-interacciones mejoradas */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in forwards;
            }
            
            /* Estilos para el header de fecha del modal de calendario */
            #calendar-day-title {
                transition: all 0.3s ease;
            }
            
            /* Modo claro - Colores naranjas */
            #calendar-day-title .text-3xl {
                background: linear-gradient(135deg, #ea580c, #f97316);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                font-weight: 900;
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
                line-height: 1;
            }
            
            #calendar-day-title .text-lg {
                color: #9a3412;
                letter-spacing: 0.1em;
                font-weight: 700;
            }
            
            #calendar-day-title .text-xs {
                color: #7c2d12;
                margin-top: 4px;
                font-weight: 500;
            }
            
            /* Modo oscuro - Colores magenta */
            .dark #calendar-day-title .text-3xl {
                background: linear-gradient(135deg, #d946ef, #a855f7);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .dark #calendar-day-title .text-lg {
                color: #c084fc;
                font-weight: 700;
            }
            
            .dark #calendar-day-title .text-xs {
                color: #a78bfa;
                font-weight: 500;
            }
            
            /* Mejoras de legibilidad para el modal de calendario */
            #calendar-day-modal .bg-theme-card {
                background-color: #ffffff;
                border: 1px solid #e5e7eb;
            }
            
            .dark #calendar-day-modal .bg-theme-card {
                background-color: #1f2937;
                border: 1px solid #374151;
            }
            
            /* Forzar colores espec√≠ficos en el modal del calendario */
            #calendar-day-modal .text-violet-800 {
                color: #5b21b6 !important;
            }
            
            #calendar-day-modal .text-blue-900 {
                color: #1e3a8a !important;
            }
            
            #calendar-day-modal .text-violet-700 {
                color: #6d28d9 !important;
            }
            
            #calendar-day-modal .text-blue-800 {
                color: #1e40af !important;
            }
            
            #calendar-day-modal .text-violet-900 {
                color: #4c1d95 !important;
            }
            
            /* Estilos m√°s espec√≠ficos para elementos del modal */
            #calendar-day-modal h4 {
                color: #1e3a8a !important;
            }
            
            #calendar-day-modal p {
                color: #6d28d9 !important;
            }
            
            #calendar-day-modal .text-xs {
                color: #1e40af !important;
            }
            
            #calendar-day-modal .text-sm {
                color: #5b21b6 !important;
            }
            
            /* Forzar colores en modo oscuro */
            .dark #calendar-day-modal .text-violet-800,
            .dark #calendar-day-modal .text-blue-900,
            .dark #calendar-day-modal .text-violet-700,
            .dark #calendar-day-modal .text-blue-800,
            .dark #calendar-day-modal .text-violet-900,
            .dark #calendar-day-modal h4,
            .dark #calendar-day-modal p,
            .dark #calendar-day-modal .text-xs,
            .dark #calendar-day-modal .text-sm {
                color: #e2e8f0 !important;
            }
            
            /* ‚ú® FASE 3: Optimizaciones espec√≠ficas para m√≥vil */
            
            /* Scrollbar m√≥vil mejorada */
            @media (max-width: 768px) {
                .custom-scrollbar::-webkit-scrollbar {
                    width: 4px;
                }
                
                .custom-scrollbar::-webkit-scrollbar-thumb {
                    background: rgba(156, 163, 175, 0.5);
                    border-radius: 2px;
                }
                
                .custom-scrollbar::-webkit-scrollbar-track {
                    background: transparent;
                }
            }
            
            /* Touch-friendly interactions */
            .touch-action-manipulation {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Mejoras de performance m√≥vil */
            @media (max-width: 768px) {
                .task-card-animate {
                    animation-duration: 0.2s;
                }
                
                .hover-lift {
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                }
                
                /* Optimizar animaciones para m√≥vil */
                * {
                    -webkit-backface-visibility: hidden;
                    backface-visibility: hidden;
                    -webkit-perspective: 1000px;
                    perspective: 1000px;
                }
            }
            
            /* Feedback visual para touch */
            @media (max-width: 768px) {
                button:active {
                    transform: scale(0.95);
                    opacity: 0.8;
                }
                
                .task-card:active {
                    transform: scale(0.98);
                }
            }
            
            /* Espaciado mejorado para thumbs */
            @media (max-width: 640px) {
                #calendar-day-modal .flex-col button,
                #calendar-day-modal .flex-row button {
                    min-height: 44px;
                    min-width: 44px;
                }
            }
            
            /* Truncate text utilities para m√≥vil */
            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            
            /* Prevenir zoom en inputs en iOS */
            @media screen and (max-width: 768px) {
                input[type="text"],
                input[type="email"],
                input[type="password"],
                textarea,
                select {
                    font-size: 16px !important;
                }
            }
            
            /* Estilos para swipe indicators */
            .swipe-indicator {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 3px;
                height: 30px;
                background: linear-gradient(to bottom, transparent, rgba(59, 130, 246, 0.7), transparent);
                border-radius: 2px;
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: 10;
            }
            
            .swipe-indicator.left {
                left: 10px;
            }
            
            .swipe-indicator.right {
                right: 10px;
            }
            
            .swipe-indicator.active {
                opacity: 1;
                animation: swipePulse 1.5s infinite;
            }
            
            @keyframes swipePulse {
                0%, 100% { opacity: 0.5; transform: translateY(-50%) scale(1); }
                50% { opacity: 1; transform: translateY(-50%) scale(1.1); }
            }
            
            /* Soporte para reduced motion */
            @media (prefers-reduced-motion: reduce) {
                .reduced-motion *,
                .reduced-motion *::before,
                .reduced-motion *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                    scroll-behavior: auto !important;
                }
            }
            
            /* Loading states optimizados para m√≥vil */
            .mobile-loading {
                position: relative;
                overflow: hidden;
            }
            
            .mobile-loading::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                animation: shimmer 1.5s infinite;
            }
            
            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 100%; }
            }
            
            /* Mejorar rendimiento de scroll en m√≥vil */
            #calendar-day-tasks {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            /* Estilos simples para el modal del calendario */
            .mobile-calendar-modal {
                background: rgba(17, 24, 39, 0.95);
            }
            
            .desktop-calendar-modal .bg-theme-card {
                background-color: #ffffff;
                border: 1px solid #e5e7eb;
            }
            
            .dark .desktop-calendar-modal .bg-theme-card {
                background-color: #1f2937;
                border: 1px solid #374151;
            }
            
            /* Estilos para las tareas en el modal */
            .calendar-task-item {
                padding: 0.75rem;
                border-radius: 0.5rem;
                border-left: 3px solid #3b82f6;
                background: rgba(59, 130, 246, 0.1);
                margin-bottom: 0.5rem;
            }
            
            .calendar-task-item.completed {
                opacity: 0.6;
                border-left-color: #10b981;
                background: rgba(16, 185, 129, 0.1);
            }
            
            .calendar-task-item.high-priority {
                border-left-color: #ef4444;
                background: rgba(239, 68, 68, 0.1);
            }
            
            .calendar-task-item.medium-priority {
                border-left-color: #f59e0b;
                background: rgba(245, 158, 11, 0.1);
            }
            
            .calendar-task-item.low-priority {
                border-left-color: #10b981;
                background: rgba(16, 185, 129, 0.1);
            }
            
            /* Animaciones de botones mejoradas */
            .calendar-modal button {
                position: relative;
                overflow: hidden;
            }
            
            .calendar-modal button::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition: width 0.3s, height 0.3s;
            }
            
            .calendar-modal button:active::before {
                width: 100px;
                height: 100px;
            }
            
            /* Modal de calendario con animaci√≥n de entrada mejorada */
            .calendar-modal .modal-content {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            }
            
            /* Rotaciones para botones de acci√≥n */
            .rotate-on-hover:hover {
                transform: rotate(10deg) scale(1.1);
            }
            
            /* Mejoras visuales para tareas completadas */
            .task-completed {
                position: relative;
                overflow: hidden;
            }
            
            .task-completed::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.2), transparent);
                animation: shine 1.5s ease-in-out;
            }
            
            @keyframes shine {
                0% {
                    left: -100%;
                }
                100% {
                    left: 100%;
                }
            }
        </style>
        
        <!-- Modal de Acciones para Mobile (3 puntos) -->
        <div id="mobile-task-actions-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end justify-center p-4">
            <div class="bg-theme-card rounded-t-xl shadow-2xl w-full max-w-sm transform transition-all translate-y-full">
                <div class="p-4">
                    <div class="w-12 h-1 bg-gray-400 rounded-full mx-auto mb-4"></div>
                    <h3 class="text-lg font-medium mb-4 text-center">Acciones de Tarea</h3>
                    <div class="space-y-2">
                        <button id="mobile-edit-task-btn" class="w-full flex items-center px-4 py-3 text-left hover:bg-theme/50 rounded-lg transition-colors">
                            <i data-feather="edit-2" class="w-5 h-5 mr-3 text-blue-400"></i>
                            <span>Editar Tarea</span>
                        </button>
                        <button id="mobile-delete-task-btn" class="w-full flex items-center px-4 py-3 text-left hover:bg-theme/50 rounded-lg transition-colors">
                            <i data-feather="trash-2" class="w-5 h-5 mr-3 text-red-400"></i>
                            <span>Eliminar Tarea</span>
                        </button>
                        <button id="mobile-move-task-btn" class="w-full flex items-center px-4 py-3 text-left hover:bg-theme/50 rounded-lg transition-colors">
                            <i data-feather="move" class="w-5 h-5 mr-3 text-purple-400"></i>
                            <span>Mover a...</span>
                            <i data-feather="chevron-right" class="w-4 h-4 ml-auto text-gray-400"></i>
                        </button>
                    </div>
                    <button id="mobile-actions-cancel-btn" class="w-full mt-4 py-3 bg-gray-600 text-white rounded-lg font-medium">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal de Movimiento de Tareas para Mobile -->
        <div id="mobile-move-task-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end justify-center p-4">
            <div class="bg-theme-card rounded-t-xl shadow-2xl w-full max-w-sm transform transition-all translate-y-full">
                <div class="p-4">
                    <div class="w-12 h-1 bg-gray-400 rounded-full mx-auto mb-4"></div>
                    <h3 class="text-lg font-medium mb-4 text-center">Mover Tarea a...</h3>
                    <div id="move-options-container" class="space-y-2">
                        <!-- Las opciones se generan din√°micamente -->
                    </div>
                    <button id="mobile-move-cancel-btn" class="w-full mt-4 py-3 bg-gray-600 text-white rounded-lg font-medium">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal de Confirmaci√≥n -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-sm text-center transform transition-all opacity-0 -translate-y-10" role="alertdialog" aria-modal="true">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 id="confirm-title" class="text-lg font-medium leading-6"></h3>
                <div class="mt-2">
                    <p id="confirm-message" class="text-sm text-gray-400"></p>
                </div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button type="button" id="cancel-confirm-btn" class="px-4 py-2 rounded-md text-gray-400 hover:bg-gray-700">Cancelar</button>
                    <button type="button" id="confirm-action-btn" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Informaci√≥n -->
        <div id="info-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-sm text-center transform transition-all opacity-0 -translate-y-10" role="alertdialog" aria-modal="true">
                <div id="info-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                    <!-- Icono din√°mico aqu√≠ -->
                </div>
                <h3 id="info-title" class="text-lg font-medium leading-6"></h3>
                <div class="mt-2">
                    <p id="info-message" class="text-sm text-gray-400"></p>
                </div>
                <div class="mt-6">
                    <button type="button" id="close-info-btn" class="w-full px-6 py-2 bg-theme-primary text-white rounded-md font-semibold">Aceptar</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Importar sistema de logs optimizado y hacer disponible globalmente
        import './src/utils/logger.js';
        
        // Importar sistemas de optimizaci√≥n (Fase 5)
        import './src/utils/resource-optimizer.js';
        import './src/utils/bundle-manager.js';
        
        // Importar m√≥dulos de Firebase y autenticaci√≥n
        import { authManager } from './src/auth.js';
        import { dataManager } from './src/utils/storage.js';
        
        // Hacer disponibles globalmente para el script principal
        window.authManager = authManager;
        window.dataManager = dataManager;
        
        // Asegurar que Logger est√© disponible globalmente
        if (!window.Logger) {
            console.warn('Logger no disponible, creando fallback');
            window.Logger = {
                success: console.log.bind(console, '‚úÖ'),
                error: console.error.bind(console, '‚ùå'),
                warn: console.warn.bind(console, '‚ö†Ô∏è'),
                info: console.log.bind(console, '‚ÑπÔ∏è'),
                debug: console.log.bind(console, 'üîç'),
                perf: console.log.bind(console, '‚ö°'),
                pwa: console.log.bind(console, 'üì±'),
                firebase: console.log.bind(console, 'üî•'),
                db: console.log.bind(console, 'üóÑÔ∏è'),
                nav: console.log.bind(console, 'üß≠')
            };
        }
    </script>

    <script>
    // =================================================================================
    // ORION APP - v2.4 (Unified Background & Fixes)
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        
        // EVENTO DIRECTO PARA EL BOT√ìN COMENZAR (Backup simple)
        const startBtn = document.getElementById('start-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const loginScreen = document.getElementById('login-screen');
        
        if (startBtn && welcomeScreen && loginScreen) {
            startBtn.addEventListener('click', () => {
                // Debug removido para producci√≥n
                
                // Ocultar welcome screen completamente
                welcomeScreen.style.display = 'none';
                
                // FORZAR ABSOLUTA VISIBILIDAD del login screen
                loginScreen.style.display = 'flex';
                loginScreen.style.opacity = '1';
                loginScreen.style.visibility = 'visible';
                loginScreen.style.zIndex = '9999';
                loginScreen.style.position = 'fixed';
                loginScreen.style.top = '0';
                loginScreen.style.left = '0';
                loginScreen.style.width = '100vw';
                loginScreen.style.height = '100vh';
                loginScreen.style.backgroundColor = 'rgba(17, 15, 26, 0.95)'; // Fondo semi-transparente
                
                // Remover clases problem√°ticas
                loginScreen.classList.remove('hidden', 'opacity-0');
                loginScreen.classList.add('opacity-100');
                
                // Debug de pantalla de login removido para producci√≥n
            });
        } else {
            console.error('No se encontraron los elementos necesarios:', {
                startBtn: !!startBtn,
                welcomeScreen: !!welcomeScreen,
                loginScreen: !!loginScreen
            });
        }
        
        // Usar la variable IS_DEV global definida anteriormente
        const IS_DEV = window.IS_DEV;
    
        // -----------------------------------------------------------------------------
        // A. ESTADO GLOBAL Y CONFIGURACI√ìN
        // -----------------------------------------------------------------------------
        const AppState = {
            user: {
                name: 'Usuario',
                theme: 'dark',
                streak: 0,
                lastCompletionDate: null,
            },
            projects: [],
            tasks: [],
            filters: {
                search: '',
                projectId: 'all'
            },
            currentDate: new Date(),
            selectedCalendarDate: null,
        };

        // -----------------------------------------------------------------------------
        // ERROR BOUNDARY Y MANEJO DE ERRORES
        // -----------------------------------------------------------------------------
        const ErrorHandler = {
            _errorCount: 0,
            _lastError: null,

            handleError(error, context = 'Unknown') {
                this._errorCount++;
                this._lastError = { error, context, timestamp: Date.now() };
                
                if (IS_DEV) {
                    Logger.error(`[${context}] Error:`, error);
                }

                // Mostrar error al usuario solo si es cr√≠tico
                if (this._errorCount > 3) {
                    this.showCriticalError();
                } else {
                    this.showRecoverableError(context);
                }
            },

            showRecoverableError(context) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg z-50 opacity-0 transition-opacity';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <span>‚ö†Ô∏è Error en ${context}. Reintentando...</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">√ó</button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.remove('opacity-0'), 100);
                setTimeout(() => notification.remove(), 4000);
            },

            showCriticalError() {
                App.openInfoModal({
                    title: 'Error Cr√≠tico',
                    message: 'La aplicaci√≥n ha encontrado errores m√∫ltiples. Se recomienda recargar la p√°gina.',
                    type: 'error'
                });
            },

            reset() {
                this._errorCount = 0;
                this._lastError = null;
            }
        };

        // Capturar errores globales
        window.addEventListener('error', (event) => {
            ErrorHandler.handleError(event.error, 'Global');
        });

        window.addEventListener('unhandledrejection', (event) => {
            ErrorHandler.handleError(event.reason, 'Promise');
        });

        // -----------------------------------------------------------------------------
        // UTILIDADES DE RENDIMIENTO
        // -----------------------------------------------------------------------------
        const PerformanceUtils = {
            // Debounce para evitar renderizados excesivos
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // Throttle para eventos de scroll
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }
        };

        // -----------------------------------------------------------------------------
        // UTILIDADES DE ICONOS
        // -----------------------------------------------------------------------------
        const IconUtils = {
            // Funci√≥n segura para reemplazar iconos de feather
            safeFeatherReplace() {
                if (window.feather && window.feather.replace) {
                    try {
                        feather.replace();
                    } catch (error) {
                        if (IS_DEV) {
                            Logger.warn('Error al procesar iconos feather:', error);
                        }
                    }
                }
            }
        };

        // -----------------------------------------------------------------------------
        // B. SELECTORES DEL DOM
        // -----------------------------------------------------------------------------
        const DOM = {
            // Body
            body: document.body,
            // Canvas
            starfieldCanvas: document.getElementById('starfield-canvas'),
            // Pantallas
            welcomeScreen: document.getElementById('welcome-screen'),
            loginScreen: document.getElementById('login-screen'),
            mainApp: document.getElementById('main-app'),
            slogan: document.getElementById('slogan'),
            startBtn: document.getElementById('start-btn'),
            mainTitle: document.getElementById('main-title'),

            // Login
            googleSigninBtn: document.getElementById('google-signin-btn'),
            guestSigninBtn: document.getElementById('guest-signin-btn'),
            backToWelcomeBtn: document.getElementById('back-to-welcome-btn'),
            loginLoading: document.getElementById('login-loading'),
    
            // Navegaci√≥n
            navButtons: document.querySelectorAll('.nav-btn'),
            mobileNavButtons: document.querySelectorAll('.mobile-nav-btn'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            mobileMenu: document.getElementById('mobile-menu'),
            closeMobileMenu: document.getElementById('close-mobile-menu'),
    
            // Secciones
            sections: document.querySelectorAll('.app-section'),
    
            // Dashboard
            userName: document.getElementById('user-name'),
            connectionStatus: document.getElementById('connection-status'),
            statusIndicator: document.getElementById('status-indicator'),
            statusText: document.getElementById('status-text'),
            todayTasksList: document.getElementById('today-tasks-list'),
            upcomingTasksList: document.getElementById('upcoming-tasks-list'),
            streakCount: document.getElementById('streak-count'),
            projectSummaryList: document.getElementById('project-summary-list'),
    
            // Tareas y Filtros
            createTaskBtn: document.getElementById('create-task-btn'),
            createProjectBtn: document.getElementById('create-project-btn'),
            quickSaveBtn: document.getElementById('quick-save-btn'),
            todoColumn: document.getElementById('todo-column'),
            doingColumn: document.getElementById('doing-column'),
            completedColumn: document.getElementById('completed-column'),
            searchTasksInput: document.getElementById('search-tasks-input'),
            projectFilterSelect: document.getElementById('project-filter-select'),
    
            // Calendario
            monthYearHeader: document.getElementById('month-year-header'),
            calendarGrid: document.getElementById('calendar-grid'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            gotoTodayBtn: document.getElementById('goto-today-btn'),
    
            // Kaizen
            tryKaizenBtn: document.getElementById('try-kaizen-btn'),
    
            // Configuraci√≥n
            themeToggle: document.getElementById('theme-toggle'),
            usernameInput: document.getElementById('username-input'),
            exportJsonBtn: document.getElementById('export-json-btn'),
            importJsonInput: document.getElementById('import-json-input'),
            storageStatsBtn: document.getElementById('storage-stats-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            deleteAllBtn: document.getElementById('delete-all-btn'),
    
            // Modales
            modalContainer: document.getElementById('modal-container'),
            // Modal de Tareas
            taskModal: {
                el: document.getElementById('task-modal'),
                content: document.getElementById('task-modal').querySelector('[role="dialog"]'),
                title: document.getElementById('modal-title'),
                form: document.getElementById('task-form'),
                idInput: document.getElementById('task-id'),
                nameInput: document.getElementById('task-name'),
                projectSelect: document.getElementById('task-project'),
                descriptionInput: document.getElementById('task-description'),
                dateInput: document.getElementById('task-date'),
                calendarCheckbox: document.getElementById('task-calendar-checkbox'),
                cancelBtn: document.getElementById('cancel-task-btn'),
                saveBtn: document.getElementById('save-task-btn'),
            },
            // Modal de Proyectos
            projectModal: {
                el: document.getElementById('project-modal'),
                content: document.getElementById('project-modal').querySelector('[role="dialog"]'),
                form: document.getElementById('project-form'),
                nameInput: document.getElementById('project-name'),
                cancelBtn: document.getElementById('cancel-project-btn'),
                saveBtn: document.getElementById('save-project-btn'),
            },
            // Modal de d√≠a del calendario
            calendarDayModal: {
                el: document.getElementById('calendar-day-modal'),
                mobileTitle: document.getElementById('mobile-calendar-title'),
                desktopTitle: document.getElementById('desktop-calendar-title'),
                mobileTasks: document.getElementById('mobile-calendar-tasks'),
                desktopTasks: document.getElementById('desktop-calendar-tasks'),
                closeMobile: document.getElementById('close-mobile-calendar'),
                closeDesktop: document.getElementById('close-desktop-calendar'),
                addTaskBtn: document.getElementById('add-task-from-calendar-btn'),
                prevDayBtn: document.getElementById('prev-day-btn'),
                nextDayBtn: document.getElementById('next-day-btn'),
            },
            // Modal de Confirmaci√≥n
            confirmModal: {
                el: document.getElementById('confirm-modal'),
                content: document.getElementById('confirm-modal').querySelector('[role="alertdialog"]'),
                title: document.getElementById('confirm-title'),
                message: document.getElementById('confirm-message'),
                cancelBtn: document.getElementById('cancel-confirm-btn'),
                confirmBtn: document.getElementById('confirm-action-btn'),
            },
            // Modal de Informaci√≥n
            infoModal: {
                el: document.getElementById('info-modal'),
                content: document.getElementById('info-modal').querySelector('[role="alertdialog"]'),
                title: document.getElementById('info-title'),
                message: document.getElementById('info-message'),
                closeBtn: document.getElementById('close-info-btn'),
                iconContainer: document.getElementById('info-icon-container'),
            },
        };
    
        // -----------------------------------------------------------------------------
        // C. L√ìGICA DE DATOS (LocalStorage)
        // -----------------------------------------------------------------------------
        const DataService = {
            async load() {
                try {
                    // Cargar configuraci√≥n del usuario
                    const userConfig = await window.dataManager.loadData('user_config');
                    if (userConfig) {
                        Object.assign(AppState.user, userConfig);
                    }

                    // Cargar datos en paralelo para mejor rendimiento
                    const [tasks, projects] = await Promise.all([
                        window.dataManager.loadData('tasks'),
                        window.dataManager.loadData('projects')
                    ]);
                    
                    if (tasks && Array.isArray(tasks)) {
                        AppState.tasks = tasks;
                    }
                    
                    if (projects && Array.isArray(projects)) {
                        AppState.projects = projects;
                    }

                    if (IS_DEV) {
                        Logger.success('Datos cargados exitosamente');
                    }
                } catch (error) {
                    ErrorHandler.handleError(error, 'DataService.load');
                    if (IS_DEV) {
                        Logger.db('Error cargando datos:', error);
                    }
                    // Fallback al localStorage para compatibilidad
                    this.loadFromLocalStorage();
                }
                
                AppState.currentDate = new Date(); // Siempre resetear a la fecha actual al cargar
            },

            async save() {
                try {
                    // Guardar datos en paralelo para mejor rendimiento
                    await Promise.all([
                        window.dataManager.saveData('user_config', AppState.user),
                        window.dataManager.saveData('tasks', AppState.tasks),
                        window.dataManager.saveData('projects', AppState.projects)
                    ]);
                    
                    if (IS_DEV) {
                        Logger.db('Datos guardados exitosamente');
                    }
                } catch (error) {
                    ErrorHandler.handleError(error, 'DataService.save');
                    if (IS_DEV) {
                        Logger.db('Error guardando datos:', error);
                    }
                    // Fallback al localStorage
                    this.saveToLocalStorage();
                }
            },

            // M√©todos de fallback para compatibilidad
            loadFromLocalStorage() {
                const savedState = localStorage.getItem('orionAppState_v2');
                if (savedState) {
                    try {
                        const parsedState = JSON.parse(savedState);
                        Object.assign(AppState, parsedState);
                    } catch(e) {
                        if (IS_DEV) {
                            Logger.error("Failed to parse state from localStorage:", e);
                        }
                        localStorage.removeItem('orionAppState_v2');
                    }
                }
            },

            saveToLocalStorage() {
                localStorage.setItem('orionAppState_v2', JSON.stringify(AppState));
            }
        };
    
        // -----------------------------------------------------------------------------
        // D. RENDERIZADO Y MANIPULACI√ìN DEL DOM
        // -----------------------------------------------------------------------------
        const UIManager = {
            // -- Renderizado principal y selectivo --
            renderDashboard() {
                DOM.userName.textContent = AppState.user.name || 'Usuario';
                
                const today = new Date().toDateString();
                const tasksToday = AppState.tasks.filter(t => t.dueDate && new Date(t.dueDate).toDateString() === today);
                
                const upcomingDate = new Date();
                upcomingDate.setDate(upcomingDate.getDate() + 5);
                const tasksUpcoming = AppState.tasks.filter(t => {
                    if (!t.dueDate) return false;
                    const taskDate = new Date(t.dueDate);
                    return taskDate.toDateString() !== today && taskDate > new Date() && taskDate <= upcomingDate;
                });

                DOM.todayTasksList.innerHTML = '';
                if (tasksToday.length > 0) {
                    tasksToday.forEach(task => DOM.todayTasksList.appendChild(this.createDashboardTaskItem(task)));
                } else {
                    DOM.todayTasksList.innerHTML = '<p class="text-gray-500 text-sm">No hay tareas para hoy. ¬°Planifica algo o t√≥mate un descanso!</p>';
                }

                DOM.upcomingTasksList.innerHTML = '';
                 if (tasksUpcoming.length > 0) {
                    tasksUpcoming.forEach(task => DOM.upcomingTasksList.appendChild(this.createDashboardTaskItem(task)));
                } else {
                    DOM.upcomingTasksList.innerHTML = '<p class="text-gray-500 text-sm">No hay tareas pr√≥ximas en los siguientes 5 d√≠as.</p>';
                }
                
                DOM.streakCount.textContent = AppState.user.streak || 0;
                this.renderProjectSummary();
                IconUtils.safeFeatherReplace();
            },
    
            renderTasks() {
                // Limpiar columnas desktop
                DOM.todoColumn.innerHTML = '';
                DOM.doingColumn.innerHTML = '';
                DOM.completedColumn.innerHTML = '';
                
                const { search, projectId } = AppState.filters;
                const filteredTasks = AppState.tasks.filter(task => {
                    const matchesSearch = task.title && task.title.toLowerCase().includes(search.toLowerCase());
                    const matchesProject = projectId === 'all' || task.project === projectId || task.project === AppState.projects.find(p => p.id === projectId)?.name;
                    return matchesSearch && matchesProject;
                });
    
                const columns = {
                    todo: DOM.todoColumn,
                    doing: DOM.doingColumn,
                    completed: DOM.completedColumn,
                };

                // Contadores para mobile
                const counters = { todo: 0, doing: 0, completed: 0 };
    
                if (AppState.tasks.length === 0) {
                    DOM.todoColumn.appendChild(this.createEmptyStateCard("¬°Crea una tarea para empezar!"));
                    DOM.doingColumn.innerHTML = '';
                    DOM.completedColumn.innerHTML = '';
                } else if (filteredTasks.length === 0) {
                    const emptyCard = this.createEmptyStateCard("No hay tareas que coincidan con tu b√∫squeda.");
                    DOM.todoColumn.appendChild(emptyCard.cloneNode(true));
                    DOM.doingColumn.appendChild(emptyCard.cloneNode(true));
                    DOM.completedColumn.appendChild(emptyCard.cloneNode(true));
                } else {
                    filteredTasks.forEach(task => {
                        const taskCard = this.createTaskCard(task);
                        // Determinar status basado en el campo completed
                        let status = task.completed ? 'completed' : (task.status || 'todo');
                        columns[status]?.appendChild(taskCard);
                        counters[status]++;
                    });
    
                    Object.entries(columns).forEach(([status, col]) => {
                        if (col.children.length === 0) {
                            col.appendChild(this.createEmptyStateCard("Arrastra una tarea aqu√≠."));
                        }
                    });
                }

                // Actualizar contadores mobile
                this.updateMobileTaskCounters(counters);

                // Renderizar tareas en mobile tambi√©n
                this.renderMobileTasks(filteredTasks);

                IconUtils.safeFeatherReplace();
            },

            updateMobileTaskCounters(counters) {
                const todoCount = document.getElementById('todo-count');
                const doingCount = document.getElementById('doing-count');
                const completedCount = document.getElementById('completed-count');

                if (todoCount) todoCount.textContent = counters.todo;
                if (doingCount) doingCount.textContent = counters.doing;
                if (completedCount) completedCount.textContent = counters.completed;
            },

            renderMobileTasks(filteredTasks) {
                const mobileContainers = {
                    todo: document.getElementById('mobile-todo-column'),
                    doing: document.getElementById('mobile-doing-column'),
                    completed: document.getElementById('mobile-completed-column')
                };

                // Limpiar contenedores mobile
                Object.values(mobileContainers).forEach(container => {
                    if (container) container.innerHTML = '';
                });

                if (filteredTasks.length === 0) return;

                filteredTasks.forEach(task => {
                    let status = task.completed ? 'completed' : (task.status || 'todo');
                    const container = mobileContainers[status];
                    
                    if (container) {
                        const mobileTaskCard = this.createMobileTaskCard(task);
                        container.appendChild(mobileTaskCard);
                    }
                });
            },

            createMobileTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'bg-theme-card p-3 rounded-lg shadow-sm border-l-4 mb-2';
                card.dataset.id = task.id;
                
                const priorityStyles = {
                    low: { icon: 'chevrons-down', color: 'border-green-500', text: 'text-green-500' },
                    medium: { icon: 'minus', color: 'border-yellow-500', text: 'text-yellow-500' },
                    high: { icon: 'chevrons-up', color: 'border-red-500', text: 'text-red-500' }
                };
                const style = priorityStyles[task.priority] || priorityStyles.medium;
                card.classList.add(style.color);
    
                const projectName = AppState.projects.find(p => p.id === task.project || p.name === task.project)?.name || task.project;
    
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 pr-2">
                            <p class="font-bold text-sm">${task.title}</p>
                            ${task.description ? `<p class="text-xs text-gray-400 mt-1">${task.description}</p>` : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <i data-feather="${style.icon}" class="w-4 h-4 ${style.text}"></i>
                            <button class="mobile-task-menu-btn text-gray-400 hover:text-white p-1" data-task-id="${task.id}">
                                <i data-feather="more-vertical" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs">
                        ${projectName ? `<span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full">${projectName}</span>` : '<span></span>'}
                        ${task.dueDate ? `<span class="text-gray-500 flex items-center"><i data-feather="calendar" class="w-3 h-3 mr-1"></i> ${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                    </div>
                `;
                return card;
            },
    
            renderCalendar() {
                const grid = DOM.calendarGrid;
                while (grid.children.length > 7) {
                    grid.removeChild(grid.lastChild);
                }
    
                const date = AppState.currentDate;
                const year = date.getFullYear();
                const month = date.getMonth();
    
                DOM.monthYearHeader.textContent = `${date.toLocaleString('es-ES', { month: 'long' })} ${year}`.replace(/^\w/, c => c.toUpperCase());
    
                const firstDayOfMonth = new Date(year, month, 1);
                const firstDayOfWeek = firstDayOfMonth.getDay();
                const calendarStartDate = new Date(firstDayOfMonth);
                calendarStartDate.setDate(calendarStartDate.getDate() - firstDayOfWeek);
    
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(calendarStartDate);
                    cellDate.setDate(cellDate.getDate() + i);
    
                    const dayCell = document.createElement('div');
                    dayCell.className = 'group relative text-center py-1 cursor-pointer transition-colors aspect-square flex items-center justify-center flex-col border-t border-l border-theme';
                    dayCell.dataset.date = cellDate.toISOString().split('T')[0];
    
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'day-number w-8 h-8 flex items-center justify-center rounded-full hover:bg-theme-card/50';
                    dayNumber.textContent = cellDate.getDate();
                    dayCell.appendChild(dayNumber);
    
                    // Estilos para d√≠as fuera del mes (Ghost Days)
                    if (cellDate.getMonth() !== month) {
                        dayCell.classList.add('opacity-40');
                    }
    
                    // Estilo para el d√≠a actual
                    const today = new Date();
                    if (cellDate.toDateString() === today.toDateString()) {
                        dayNumber.classList.add('border-2', 'border-theme-primary');
                    }
    
                    // ‚ú® FASE 2: Indicadores avanzados y tooltips
                    const dayInfo = App.getDayInfo(cellDate);
                    if (dayInfo.hasTasksToday) {
                        const priorityColors = { 
                            high: { bg: 'bg-red-500', border: 'border-red-300', text: 'text-red-600' }, 
                            medium: { bg: 'bg-yellow-500', border: 'border-yellow-300', text: 'text-yellow-600' }, 
                            low: { bg: 'bg-green-500', border: 'border-green-300', text: 'text-green-600' }
                        };
                        
                        const colors = priorityColors[dayInfo.highestPriority];
                        
                        // Indicador principal de prioridad con efecto
                        const dot = document.createElement('div');
                        dot.className = `absolute bottom-2 left-1/2 -translate-x-1/2 w-2 h-2 rounded-full ${colors.bg} animate-pulse`;
                        dayCell.appendChild(dot);
                        
                        // Contador de tareas con mejor dise√±o
                        if (dayInfo.total > 1) {
                            const counter = document.createElement('div');
                            counter.className = `absolute -top-1 -right-1 min-w-5 h-5 ${colors.bg} text-white text-xs font-bold rounded-full flex items-center justify-center shadow-md border-2 border-white`;
                            counter.textContent = dayInfo.total > 99 ? '99+' : dayInfo.total;
                            dayCell.appendChild(counter);
                        }
                        
                        // Barra de progreso mejorada
                        if (dayInfo.completed > 0) {
                            const progressContainer = document.createElement('div');
                            progressContainer.className = 'absolute bottom-0 left-0 w-full h-1 bg-gray-200 dark:bg-gray-700 rounded-b-lg overflow-hidden';
                            
                            const progressBar = document.createElement('div');
                            progressBar.className = 'h-full bg-gradient-to-r from-green-400 to-green-600 transition-all duration-300';
                            progressBar.style.width = `${(dayInfo.completed / dayInfo.total) * 100}%`;
                            
                            progressContainer.appendChild(progressBar);
                            dayCell.appendChild(progressContainer);
                        }
                        
                        // ‚ú® NUEVO: Tooltip informativo
                        const tooltip = this.createDayTooltip(dayInfo, cellDate);
                        dayCell.appendChild(tooltip);
                        
                        // A√±adir efectos hover
                        dayCell.classList.add('hover:scale-105', 'transition-transform', 'duration-200');
                    }
                    
                    grid.appendChild(dayCell);
                }
                IconUtils.safeFeatherReplace();
                
                // ‚ú® FASE 2: Configurar tooltips despu√©s del renderizado
                this.setupCalendarTooltips();
            },

            // ‚ú® FASE 2: Crear tooltip informativo para d√≠as
            createDayTooltip(dayInfo, date) {
                const tooltip = document.createElement('div');
                tooltip.className = 'day-tooltip absolute z-50 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg opacity-0 pointer-events-none transition-all duration-200 transform -translate-y-2 min-w-48';
                tooltip.style.bottom = '100%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%) translateY(-8px)';
                
                const dateStr = date.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long' 
                });
                
                // Crear vista previa de tareas
                const taskPreviews = dayInfo.tasks.slice(0, 3).map(task => {
                    const priorityIcon = task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : 'üü¢';
                    const statusIcon = task.completed ? '‚úÖ' : task.status === 'doing' ? '‚è≥' : '‚≠ï';
                    return `${priorityIcon}${statusIcon} ${task.title.length > 20 ? task.title.slice(0, 20) + '...' : task.title}`;
                }).join('<br>');
                
                const moreTasksText = dayInfo.total > 3 ? `<br><span class="text-gray-400">+${dayInfo.total - 3} tareas m√°s...</span>` : '';
                
                tooltip.innerHTML = `
                    <div class="font-semibold mb-2">${dateStr}</div>
                    <div class="mb-2">
                        <span class="text-blue-300">${dayInfo.total}</span> tarea${dayInfo.total > 1 ? 's' : ''} ‚Ä¢
                        <span class="text-green-300">${dayInfo.completed}</span> completada${dayInfo.completed !== 1 ? 's' : ''} ‚Ä¢
                        <span class="text-orange-300">${dayInfo.pending}</span> pendiente${dayInfo.pending !== 1 ? 's' : ''}
                    </div>
                    ${dayInfo.total > 0 ? `
                        <div class="border-t border-gray-700 pt-2 text-xs">
                            ${taskPreviews}
                            ${moreTasksText}
                        </div>
                        <div class="text-center mt-2 text-gray-400 text-xs">
                            Click para ver detalles
                        </div>
                    ` : ''}
                `;
                
                // Flecha del tooltip
                const arrow = document.createElement('div');
                arrow.className = 'absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900';
                tooltip.appendChild(arrow);
                
                return tooltip;
            },

            // ‚ú® FASE 2: Configurar tooltips hover
            setupCalendarTooltips() {
                const calendarGrid = DOM.calendarGrid;
                let currentTooltip = null;
                let hoverTimeout = null;
                
                calendarGrid.addEventListener('mouseenter', (e) => {
                    const dayCell = e.target.closest('[data-date]');
                    if (!dayCell) return;
                    
                    const tooltip = dayCell.querySelector('.day-tooltip');
                    if (!tooltip) return;
                    
                    // Limpiar timeout anterior
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                    }
                    
                    // Ocultar tooltip anterior
                    if (currentTooltip && currentTooltip !== tooltip) {
                        currentTooltip.style.opacity = '0';
                        currentTooltip.style.pointerEvents = 'none';
                    }
                    
                    // Mostrar nuevo tooltip con delay
                    hoverTimeout = setTimeout(() => {
                        tooltip.style.opacity = '1';
                        tooltip.style.pointerEvents = 'auto';
                        currentTooltip = tooltip;
                    }, 500); // Delay de 500ms
                    
                }, true);
                
                calendarGrid.addEventListener('mouseleave', (e) => {
                    const dayCell = e.target.closest('[data-date]');
                    if (!dayCell) return;
                    
                    const tooltip = dayCell.querySelector('.day-tooltip');
                    if (!tooltip) return;
                    
                    // Limpiar timeout si existe
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    
                    // Ocultar tooltip
                    tooltip.style.opacity = '0';
                    tooltip.style.pointerEvents = 'none';
                    
                    if (currentTooltip === tooltip) {
                        currentTooltip = null;
                    }
                }, true);
            },
    
            renderSettings() {
                DOM.usernameInput.value = AppState.user.name;
                this.applyTheme();
            },
            
            renderProjectFilters() {
                const select = DOM.projectFilterSelect;
                const taskProjectSelect = DOM.taskModal.projectSelect;
                const currentFilter = select.value;
                const currentTaskProject = taskProjectSelect.value;
                
                select.innerHTML = '<option value="all">Todos los proyectos</option>';
                taskProjectSelect.innerHTML = '<option value="none">Sin proyecto</option>';
    
                AppState.projects.forEach(p => {
                    const option = new Option(p.name, p.id);
                    select.add(option.cloneNode(true));
                    taskProjectSelect.add(option);
                });
                
                select.value = currentFilter;
                taskProjectSelect.value = currentTaskProject;
            },

            renderProjectSummary() {
                DOM.projectSummaryList.innerHTML = '';
                if (AppState.projects.length === 0) {
                    DOM.projectSummaryList.innerHTML = '<p class="text-gray-500 text-sm">A√∫n no has creado ning√∫n proyecto.</p>';
                    return;
                }

                AppState.projects.forEach(project => {
                    const projectTasks = AppState.tasks.filter(t => t.project === project.id || t.project === project.name);
                    const completedTasks = projectTasks.filter(t => t.completed === true).length;
                    const totalTasks = projectTasks.length;
                    const percentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

                    const item = document.createElement('div');
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-sm">${project.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400">${completedTasks}/${totalTasks}</span>
                                <button class="delete-project-btn text-gray-500 hover:text-red-500" data-project-id="${project.id}"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="w-full bg-theme-card/50 rounded-full h-2.5">
                            <div class="bg-theme-primary h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    DOM.projectSummaryList.appendChild(item);
                });
                IconUtils.safeFeatherReplace();
            },

            // -- Creaci√≥n de elementos --
            createTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'task-card bg-theme-card p-3 rounded-lg shadow-md border-l-4 transition-all duration-300';
                card.dataset.id = task.id;
                
                const priorityStyles = {
                    low: { icon: 'chevrons-down', color: 'border-green-500', text: 'text-green-500' },
                    medium: { icon: 'minus', color: 'border-yellow-500', text: 'text-yellow-500' },
                    high: { icon: 'chevrons-up', color: 'border-red-500', text: 'text-red-500' }
                };
                const style = priorityStyles[task.priority] || priorityStyles.medium;
                card.classList.add(style.color);
    
                const projectName = AppState.projects.find(p => p.id === task.project || p.name === task.project)?.name || task.project;
    
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold pr-2">${task.title}</p>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <i data-feather="${style.icon}" class="w-4 h-4 ${style.text}"></i>
                            <button class="edit-task-btn text-gray-400 hover:text-white"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                            <button class="delete-task-btn text-gray-400 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">${task.description || ''}</p>
                    <div class="flex justify-between items-center mt-3 text-xs">
                        ${projectName ? `<span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full">${projectName}</span>` : '<span></span>'}
                        ${task.dueDate ? `<span class="text-gray-500 flex items-center"><i data-feather="calendar" class="w-3 h-3 mr-1"></i> ${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                    </div>
                `;
                return card;
            },
            
            createEmptyStateCard(message) {
                const card = document.createElement('div');
                card.className = 'text-center text-sm text-gray-500 p-6 bg-theme-card/20 rounded-lg border-2 border-dashed border-theme';
                card.innerHTML = `<i data-feather="coffee" class="mx-auto mb-2"></i><p>${message}</p>`;
                return card;
            },

            createDashboardTaskItem(task) {
                const item = document.createElement('div');
                item.className = 'bg-theme-card/50 p-3 rounded-lg flex items-center justify-between border-b border-theme last:border-b-0';
                const priorityStyles = {
                    high: 'bg-red-500',
                    medium: 'bg-yellow-500',
                    low: 'bg-green-500',
                };
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">${task.title}</p>
                        <p class="text-xs text-gray-400">${task.dueDate ? new Date(task.dueDate).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' }) : 'Sin fecha'}</p>
                    </div>
                    <div class="w-2 h-2 rounded-full ${priorityStyles[task.priority] || 'bg-gray-500'}"></div>
                `;
                return item;
            },

            // -- Utilidades de UI --
            applyTheme() {
                const html = document.documentElement;
                if (AppState.user.theme === 'dark') {
                    html.classList.add('dark');
                    html.classList.remove('light');
                    DOM.themeToggle.checked = true;
                    DOM.body.classList.add('dark');
                    DOM.body.classList.remove('light');
                } else {
                    html.classList.add('light');
                    html.classList.remove('dark');
                    DOM.themeToggle.checked = false;
                    DOM.body.classList.add('light');
                    DOM.body.classList.remove('dark');
                }
            },
    
            setButtonLoading(button, isLoading) {
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.innerHTML;
                    button.innerHTML = '<span class="loader"></span>';
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText;
                }
            },

            // -- Skeleton Loading para mejor UX --
            showSkeletonTasks() {
                const columns = [DOM.todoColumn, DOM.doingColumn, DOM.completedColumn];
                columns.forEach(column => {
                    column.innerHTML = '';
                    for (let i = 0; i < 3; i++) {
                        const skeleton = document.createElement('div');
                        skeleton.className = 'skeleton skeleton-card bg-theme-card p-3 rounded-lg';
                        column.appendChild(skeleton);
                    }
                });
            },

            showSkeletonDashboard() {
                DOM.todayTasksList.innerHTML = `
                    <div class="skeleton skeleton-text w-3/4"></div>
                    <div class="skeleton skeleton-text w-1/2"></div>
                    <div class="skeleton skeleton-text w-2/3"></div>
                `;
                DOM.upcomingTasksList.innerHTML = `
                    <div class="skeleton skeleton-text w-4/5"></div>
                    <div class="skeleton skeleton-text w-3/5"></div>
                `;
            },

            hideSkeletons() {
                document.querySelectorAll('.skeleton').forEach(el => el.remove());
            }
        };

        // Versiones optimizadas con debounce para funciones de renderizado cr√≠ticas
        UIManager.renderTasksDebounced = PerformanceUtils.debounce(UIManager.renderTasks.bind(UIManager), 100);
        UIManager.renderDashboardDebounced = PerformanceUtils.debounce(UIManager.renderDashboard.bind(UIManager), 150);
        UIManager.renderCalendarDebounced = PerformanceUtils.debounce(UIManager.renderCalendar.bind(UIManager), 200);

        // -----------------------------------------------------------------------------
        // E. GESTOR DE MODALES Y ACCESIBILIDAD
        // -----------------------------------------------------------------------------
        const ModalManager = {
            _currentlyOpen: null,
            _focusableElements: 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
    
            open(modal) {
                this._currentlyOpen = modal;
                modal.el.classList.remove('hidden');
                setTimeout(() => {
                    modal.content.classList.remove('opacity-0', '-translate-y-10');
                    const firstFocusable = modal.content.querySelector(this._focusableElements);
                    if (firstFocusable) firstFocusable.focus();
                }, 10);
                document.addEventListener('keydown', this._handleKeydown);
            },
    
            close(modal) {
                this._currentlyOpen = null;
                modal.content.classList.add('opacity-0', '-translate-y-10');
                
                // Reset z-index for task modal when closing
                if (modal === DOM.taskModal) {
                    modal.el.style.zIndex = '50';
                }
                
                setTimeout(() => modal.el.classList.add('hidden'), 300);
                document.removeEventListener('keydown', this._handleKeydown);
            },
    
            _handleKeydown: (e) => {
                if (e.key === 'Escape' && ModalManager._currentlyOpen) {
                    ModalManager.close(ModalManager._currentlyOpen);
                }
                if (e.key === 'Tab' && ModalManager._currentlyOpen) {
                    const modal = ModalManager._currentlyOpen;
                    const focusableContent = Array.from(modal.content.querySelectorAll(ModalManager._focusableElements));
                    const firstFocusableElement = focusableContent[0];
                    const lastFocusableElement = focusableContent[focusableContent.length - 1];
    
                    if (e.shiftKey) { // Shift + Tab
                        if (document.activeElement === firstFocusableElement) {
                            lastFocusableElement.focus();
                            e.preventDefault();
                        }
                    } else { // Tab
                        if (document.activeElement === lastFocusableElement) {
                            firstFocusableElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            }
        };

        // -----------------------------------------------------------------------------
        // COMPONENTE LAZY LOADER
        // -----------------------------------------------------------------------------
        const ComponentLoader = {
            _loadedComponents: new Set(),
            
            async loadStarfield() {
                if (this._loadedComponents.has('starfield')) return;
                
                // Solo cargar starfield cuando se muestre la pantalla de bienvenida
                if (!DOM.welcomeScreen.classList.contains('hidden')) {
                    App.initStarfield();
                    this._loadedComponents.add('starfield');
                }
            },
            
            async loadSortable() {
                if (this._loadedComponents.has('sortable')) return;
                
                // Esperar a que SortableJS est√© disponible
                return new Promise((resolve) => {
                    const checkSortable = () => {
                        if (window.Sortable) {
                            App.initSortable();
                            this._loadedComponents.add('sortable');
                            resolve();
                        } else {
                            setTimeout(checkSortable, 100);
                        }
                    };
                    checkSortable();
                });
            },
            
            async loadCalendar() {
                if (this._loadedComponents.has('calendar')) return;
                
                // Cargar calendario solo cuando se navegue a √©l
                UIManager.renderCalendar();
                this._loadedComponents.add('calendar');
            }
        };

        // -----------------------------------------------------------------------------
        // F. L√ìGICA DE LA APLICACI√ìN Y MANEJADORES DE EVENTOS
        // -----------------------------------------------------------------------------
        const App = {
            init() {
                // ‚ú® VERIFICACI√ìN TEMPRANA DE AUTENTICACI√ìN
                const wasAuthenticated = this.checkExistingAuth();
                
                // Cargar recursos cr√≠ticos primero
                window.lazyLoadResources();
                
                DataService.load();
                this.setupEventListeners();
                UIManager.applyTheme();
                this.renderInitialUI();
                
                // Solo mostrar animaci√≥n de bienvenida si no est√° autenticado
                if (!wasAuthenticated && !this.isUserAuthenticated()) {
                    this.initWelcomeAnimation();
                }
                
                // ‚ú® REMOVER LOADING STATE - App lista para mostrar
                setTimeout(() => {
                    document.body.classList.remove('page-loading');
                    document.body.style.overflow = ''; // Restaurar scroll
                }, wasAuthenticated ? 100 : 500); // M√°s r√°pido si ya autenticado
                
                // Carga diferida de componentes pesados
                ComponentLoader.loadStarfield();
                setTimeout(() => ComponentLoader.loadSortable(), 1000);
                
                this.updateNotificationIndicator();
            },

            // ‚ú® NUEVO: Verificar autenticaci√≥n existente
            checkExistingAuth() {
                // Verificar si hay datos de usuario persistidos
                const savedState = localStorage.getItem('orionAppState_v2');
                
                if (savedState) {
                    try {
                        const parsedState = JSON.parse(savedState);
                        
                        // Si hay usuario autenticado, saltar la pantalla de bienvenida
                        if (parsedState.user && (parsedState.user.uid || parsedState.user.isGuest)) {
                            console.log('üîÑ Usuario previamente autenticado, saltando bienvenida...');
                            
                            // Aplicar clase CSS para ocultar bienvenida
                            document.body.classList.add('auth-loading');
                            
                            // Cargar estado y continuar
                            Object.assign(AppState, parsedState);
                            
                            // Simular transici√≥n a app si hay usuario v√°lido
                            if (parsedState.user.uid || parsedState.user.isGuest) {
                                setTimeout(() => {
                                    this.silentTransitionToApp(parsedState.user);
                                }, 50); // Reducido para ser m√°s r√°pido
                            }
                            
                            return true; // Usuario autenticado
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error verificando autenticaci√≥n previa:', error);
                    }
                }
                
                return false; // No autenticado
            },

            // ‚ú® NUEVO: Verificar si usuario est√° autenticado
            isUserAuthenticated() {
                return AppState.user && (AppState.user.uid || AppState.user.isGuest);
            },

            // ‚ú® NUEVO: Transici√≥n silenciosa sin animaciones
            async silentTransitionToApp(user) {
                try {
                    // Actualizar informaci√≥n del usuario
                    AppState.user.name = user.displayName || user.name || user.email || 'Usuario';
                    DOM.userName.textContent = AppState.user.name;
                    
                    // Actualizar estado de autenticaci√≥n
                    AppState.user.isGuest = user.isGuest || false;
                    AppState.user.uid = user.uid;

                    // Inicializar sistema de almacenamiento
                    if (window.dataManager) {
                        await window.dataManager.initialize();
                    }

                    // Configurar listeners
                    this.setupRealtimeListeners();
                    this.setupConnectionListeners();
                    this.updateConnectionStatus();

                    // Cargar y renderizar datos
                    await DataService.load();
                    UIManager.renderDashboard();
                    UIManager.renderTasks();
                    UIManager.renderCalendar();
                    
                    // ‚ú® Limpiar clases de carga una vez completado
                    document.body.classList.remove('auth-loading', 'page-loading');
                    document.body.style.overflow = ''; // Restaurar scroll
                    
                    if (window.IS_DEV) {
                        console.log('‚úÖ Transici√≥n silenciosa completada');
                    }
                } catch (error) {
                    console.error('‚ùå Error en transici√≥n silenciosa:', error);
                    // En caso de error, mostrar pantalla de bienvenida
                    document.body.classList.remove('auth-loading', 'page-loading');
                    document.body.style.overflow = ''; // Restaurar scroll
                    DOM.welcomeScreen.style.display = 'flex';
                    DOM.mainApp.classList.add('hidden');
                }
            },
    
            renderInitialUI() {
                UIManager.renderDashboard();
                UIManager.renderTasks();
                // Calendario se carga bajo demanda
                UIManager.renderSettings();
                UIManager.renderProjectFilters();
                
                // Cargar recursos y luego aplicar iconos
                window.lazyLoadResources();
                
                // Aplicar iconos de forma segura
                IconUtils.safeFeatherReplace();
            },
    
            initWelcomeAnimation() {
                const title = "ORION";
                const sloganText = "Organiza. Evoluciona. Expande tu universo.";
                
                DOM.mainTitle.innerHTML = '';
                title.split('').forEach((letter, index) => {
                    const span = document.createElement('span');
                    span.textContent = letter;
                    span.style.animationDelay = `${index * 0.1}s`;
                    DOM.mainTitle.appendChild(span);
                });

                const totalTitleAnimationTime = title.length * 100 + 800;

                setTimeout(() => {
                    DOM.slogan.style.opacity = 1;
                    const textSpan = document.createElement('span');
                    const caretSpan = document.createElement('span');
                    caretSpan.className = 'typewriter-caret';
                    DOM.slogan.appendChild(textSpan);
                    DOM.slogan.appendChild(caretSpan);
                    
                    let i = 0;
                    function type() {
                        if (i < sloganText.length) {
                            textSpan.textContent += sloganText.charAt(i);
                            i++;
                            setTimeout(type, 50);
                        } else {
                             setTimeout(() => {
                                DOM.startBtn.style.opacity = 1;
                                DOM.welcomeScreen.querySelector('footer').style.opacity = 1;
                             }, 300);
                        }
                    }
                    type();
                }, totalTitleAnimationTime);
            },
    
            initSortable() {
                [DOM.todoColumn, DOM.doingColumn, DOM.completedColumn].forEach(col => {
                    new Sortable(col, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: async (evt) => {
                            const taskId = evt.item.dataset.id;
                            const newStatus = evt.to.id.replace('-column', '');
                            const task = AppState.tasks.find(t => t.id === taskId);
                            if (task) {
                                task.status = newStatus;
                                task.completed = (newStatus === 'completed');
                                if (newStatus === 'completed' && !task.completedAt) {
                                    task.completedAt = Date.now();
                                    this.updateStreak();
                                } else if (newStatus !== 'completed') {
                                    task.completedAt = null;
                                }
                                await DataService.save();
                                UIManager.renderDashboard();
                                UIManager.renderProjectSummary();
                                UIManager.renderCalendar();
                            }
                        }
                    });
                });
            },
            
            initStarfield() {
                const canvas = DOM.starfieldCanvas;
                const ctx = canvas.getContext('2d');
                let stars = [];
                let animationFrameId;
                let isPaused = false;

                function resizeCanvas() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    createStars();
                }

                function createStars() {
                    stars = [];
                    const starCount = Math.floor((canvas.width * canvas.height) / 5000); 
                    for (let i = 0; i < starCount; i++) {
                        stars.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            radius: Math.random() * 1.5 + 0.5,
                            alpha: Math.random() * 0.5 + 0.5,
                            alphaChange: (Math.random() - 0.5) * 0.01
                        });
                    }
                }

                function drawStars() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Fondo base
                    const bodyBg = getComputedStyle(document.body).getPropertyValue('background-color');
                    ctx.fillStyle = bodyBg;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Estrellas
                    ctx.fillStyle = AppState.user.theme === 'dark' ? 'rgba(224, 224, 224, 0.8)' : 'rgba(74, 74, 74, 0.6)';
                    
                    stars.forEach(star => {
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                        ctx.globalAlpha = star.alpha;
                        ctx.fill();
                    });
                    ctx.globalAlpha = 1;
                }

                function updateStars() {
                    stars.forEach(star => {
                        star.alpha += star.alphaChange;
                        if (star.alpha <= 0.1 || star.alpha >= 1) {
                            star.alphaChange *= -1;
                        }
                    });
                }

                function animate() {
                    if (isPaused) return;
                    updateStars();
                    drawStars();
                    animationFrameId = requestAnimationFrame(animate);
                }
                
                window.addEventListener('resize', resizeCanvas);
                document.addEventListener('visibilitychange', () => {
                    isPaused = document.hidden;
                    if (!isPaused) {
                        animate();
                    }
                });

                resizeCanvas();
                animate();
            },
    
            // -- Manejadores de eventos --
            setupEventListeners() {
                // Bot√≥n de volver desde Login a Welcome
                DOM.backToWelcomeBtn.addEventListener('click', () => {
                    console.log('üîÑ Volviendo a pantalla de bienvenida...');
                    
                    // Ocultar login screen con estilos inline
                    DOM.loginScreen.style.display = 'none';
                    DOM.loginScreen.style.opacity = '0';
                    DOM.loginScreen.style.visibility = 'hidden';
                    
                    // Mostrar welcome screen con estilos inline
                    DOM.welcomeScreen.style.display = 'flex';
                    DOM.welcomeScreen.style.opacity = '1';
                    DOM.welcomeScreen.style.visibility = 'visible';
                    DOM.welcomeScreen.style.position = 'fixed';
                    DOM.welcomeScreen.style.top = '0';
                    DOM.welcomeScreen.style.left = '0';
                    DOM.welcomeScreen.style.width = '100vw';
                    DOM.welcomeScreen.style.height = '100vh';
                    DOM.welcomeScreen.style.zIndex = '9999';
                    
                    // Limpiar clases
                    DOM.loginScreen.classList.add('hidden');
                    DOM.welcomeScreen.classList.remove('hidden');
                    
                    console.log('‚úÖ Transici√≥n a welcome screen completada');
                });

                // Iniciar sesi√≥n con Google
                DOM.googleSigninBtn.addEventListener('click', async () => {
                    DOM.loginLoading.classList.remove('hidden');
                    
                    try {
                        const result = await window.authManager.signInWithGoogle();
                        DOM.loginLoading.classList.add('hidden');
                        
                        if (result.success) {
                            this.showNotification('¬°Bienvenido! Sesi√≥n iniciada con Google', 'success');
                            this.transitionToApp(result.user);
                        } else {
                            this.showNotification(result.error, 'error');
                        }
                    } catch (error) {
                        DOM.loginLoading.classList.add('hidden');
                        this.showNotification('Error al iniciar sesi√≥n', 'error');
                        if (IS_DEV) {
                            Logger.firebase('Error en login:', error);
                        }
                    }
                });

                // Iniciar sesi√≥n como invitado
                DOM.guestSigninBtn.addEventListener('click', () => {
                    const result = window.authManager.signInAsGuest();
                    
                    if (result.success) {
                        this.showNotification('¬°Bienvenido! Modo invitado activado', 'success');
                        this.transitionToApp(result.user);
                    } else {
                        this.showNotification('Error al iniciar modo invitado', 'error');
                    }
                });
    
                const navigate = (sectionId) => {
                    DOM.sections.forEach(s => s.classList.add('hidden'));
                    document.getElementById(sectionId).classList.remove('hidden');
                    
                    [...DOM.navButtons, ...DOM.mobileNavButtons].forEach(btn => {
                        btn.classList.toggle('bg-theme-primary', btn.dataset.section === sectionId);
                        btn.classList.toggle('text-white', btn.dataset.section === sectionId);
                    });
                    DOM.mobileMenu.classList.add('hidden');

                    if (sectionId === 'dashboard') {
                        this.updateNotificationIndicator(false); // Remove notification on visit
                    }
                };
                DOM.navButtons.forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.section)));
                DOM.mobileNavButtons.forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.section)));
                DOM.hamburgerBtn.addEventListener('click', () => DOM.mobileMenu.classList.remove('hidden'));
                DOM.closeMobileMenu.addEventListener('click', () => DOM.mobileMenu.classList.add('hidden'));
    
                // Tareas y Proyectos
                DOM.createTaskBtn.addEventListener('click', () => this.openTaskModal());
                DOM.createProjectBtn.addEventListener('click', () => ModalManager.open(DOM.projectModal));
                DOM.quickSaveBtn.addEventListener('click', () => this.exportData());
                DOM.taskModal.form.addEventListener('submit', (e) => this.handleTaskFormSubmit(e));
                DOM.projectModal.form.addEventListener('submit', (e) => this.handleProjectFormSubmit(e));
                document.getElementById('tasks').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-task-btn');
                    const deleteBtn = e.target.closest('.delete-task-btn');
                    const mobileMenuBtn = e.target.closest('.mobile-task-menu-btn');
                    const mobileHeaderBtn = e.target.closest('.mobile-task-header');
                    
                    if (editBtn) this.openTaskModal(editBtn.closest('.task-card').dataset.id);
                    if (deleteBtn) this.handleDeleteTask(deleteBtn.closest('.task-card').dataset.id);
                    if (mobileMenuBtn) {
                        const taskId = mobileMenuBtn.dataset.taskId;
                        this.openMobileTaskActionsModal(taskId);
                    }
                    if (mobileHeaderBtn) {
                        this.toggleMobileSection(mobileHeaderBtn.dataset.section);
                    }
                });
                DOM.projectSummaryList.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-project-btn');
                    if (deleteBtn) this.handleDeleteProject(deleteBtn.dataset.projectId);
                });

                // Mobile Task Actions Modal
                const mobileActionsModal = document.getElementById('mobile-task-actions-modal');
                const mobileEditBtn = document.getElementById('mobile-edit-task-btn');
                const mobileDeleteBtn = document.getElementById('mobile-delete-task-btn');
                const mobileMoveBtn = document.getElementById('mobile-move-task-btn');
                const mobileCancelBtn = document.getElementById('mobile-actions-cancel-btn');

                if (mobileEditBtn) {
                    mobileEditBtn.addEventListener('click', () => {
                        const taskId = mobileActionsModal.dataset.currentTaskId;
                        this.closeMobileTaskActionsModal();
                        this.openTaskModal(taskId);
                    });
                }

                if (mobileDeleteBtn) {
                    mobileDeleteBtn.addEventListener('click', () => {
                        const taskId = mobileActionsModal.dataset.currentTaskId;
                        this.closeMobileTaskActionsModal();
                        this.handleDeleteTask(taskId);
                    });
                }

                if (mobileMoveBtn) {
                    mobileMoveBtn.addEventListener('click', () => {
                        const taskId = mobileActionsModal.dataset.currentTaskId;
                        this.openMoveTaskModal(taskId);
                    });
                }

                if (mobileCancelBtn) {
                    mobileCancelBtn.addEventListener('click', () => {
                        this.closeMobileTaskActionsModal();
                    });
                }

                // Mobile Move Task Modal
                const mobileMoveModal = document.getElementById('mobile-move-task-modal');
                const moveOptionsContainer = document.getElementById('move-options-container');
                const mobileMoveCancelBtn = document.getElementById('mobile-move-cancel-btn');

                if (mobileMoveCancelBtn) {
                    mobileMoveCancelBtn.addEventListener('click', () => {
                        this.closeMoveTaskModal();
                    });
                }

                // Close mobile modals on backdrop click
                if (mobileActionsModal) {
                    mobileActionsModal.addEventListener('click', (e) => {
                        if (e.target === mobileActionsModal) {
                            this.closeMobileTaskActionsModal();
                        }
                    });
                }

                if (mobileMoveModal) {
                    mobileMoveModal.addEventListener('click', (e) => {
                        if (e.target === mobileMoveModal) {
                            this.closeMoveTaskModal();
                        }
                    });
                }
    
                // Filtros
                DOM.searchTasksInput.addEventListener('input', (e) => {
                    AppState.filters.search = e.target.value;
                    UIManager.renderTasks();
                });
                DOM.projectFilterSelect.addEventListener('change', (e) => {
                    AppState.filters.projectId = e.target.value;
                    UIManager.renderTasks();
                });
    
                // Calendario
                DOM.prevMonthBtn.addEventListener('click', () => { AppState.currentDate.setMonth(AppState.currentDate.getMonth() - 1); UIManager.renderCalendar(); });
                DOM.nextMonthBtn.addEventListener('click', () => { AppState.currentDate.setMonth(AppState.currentDate.getMonth() + 1); UIManager.renderCalendar(); });
                DOM.gotoTodayBtn.addEventListener('click', () => { AppState.currentDate = new Date(); UIManager.renderCalendar(); });
                DOM.calendarGrid.addEventListener('click', (e) => {
                    const dayCell = e.target.closest('[data-date]');
                    if (!dayCell) return;

                    // Siempre abrir el modal del calendario con las tareas del d√≠a
                    this.openCalendarDayModal(dayCell.dataset.date);
                });
    
                // Kaizen
                DOM.tryKaizenBtn.addEventListener('click', () => {
                    navigate('tasks');
                    setTimeout(() => {
                        this.openTaskModal(null, null, true); // Pass a flag for Kaizen
                    }, 100);
                });
    
                // Configuraci√≥n
                DOM.themeToggle.addEventListener('change', async () => { AppState.user.theme = DOM.themeToggle.checked ? 'dark' : 'light'; UIManager.applyTheme(); await DataService.save(); });
                DOM.usernameInput.addEventListener('change', async () => { AppState.user.name = DOM.usernameInput.value; await DataService.save(); UIManager.renderDashboard(); });
                DOM.exportJsonBtn.addEventListener('click', () => this.exportData());
                DOM.importJsonInput.addEventListener('change', (e) => this.importData(e));
                DOM.storageStatsBtn.addEventListener('click', () => this.showStorageStats());
                DOM.deleteAllBtn.addEventListener('click', () => this.deleteAllData());
                DOM.logoutBtn.addEventListener('click', () => this.logout());
    
                // Initialize mobile optimizations
                this.setupMobileOptimizations();
    
                // Modales
                DOM.taskModal.cancelBtn.addEventListener('click', () => ModalManager.close(DOM.taskModal));
                DOM.projectModal.cancelBtn.addEventListener('click', () => ModalManager.close(DOM.projectModal));
                // Modales de calendario - botones de cerrar
                DOM.calendarDayModal.closeMobile.addEventListener('click', () => this.closeCalendarModal());
                DOM.calendarDayModal.closeDesktop.addEventListener('click', () => this.closeCalendarModal());
                DOM.calendarDayModal.addTaskBtn.addEventListener('click', () => {
                    this.closeCalendarModal();
                    this.openTaskModal(null, AppState.selectedCalendarDate);
                });
                DOM.calendarDayModal.prevDayBtn.addEventListener('click', () => {
                    this.navigateCalendarDay(-1);
                });
                DOM.calendarDayModal.nextDayBtn.addEventListener('click', () => {
                    this.navigateCalendarDay(1);
                });
                
                // Close calendar modal on backdrop click
                DOM.calendarDayModal.el.addEventListener('click', (e) => {
                    if (e.target === DOM.calendarDayModal.el) {
                        this.closeCalendarModal();
                    }
                });
                
                DOM.confirmModal.cancelBtn.addEventListener('click', () => ModalManager.close(DOM.confirmModal));
                DOM.infoModal.closeBtn.addEventListener('click', () => ModalManager.close(DOM.infoModal));
            },
    
            // -- L√≥gica de acciones --
            openTaskModal(taskId = null, dateString = null, isKaizen = false, fromCalendar = false) {
                const modal = DOM.taskModal;
                modal.form.reset();
                UIManager.renderProjectFilters();

                // Reset placeholders
                modal.nameInput.placeholder = '';
                modal.descriptionInput.placeholder = '';

                // Adjust z-index if opened from calendar using inline styles for higher specificity
                if (fromCalendar) {
                    modal.el.style.zIndex = '60';
                } else {
                    modal.el.style.zIndex = '50';
                }

                if (isKaizen) {
                    modal.nameInput.placeholder = "Mi primera microacci√≥n";
                    modal.descriptionInput.placeholder = "Ej: Leer una p√°gina de un libro.";
                }

                if (taskId) {
                    const task = AppState.tasks.find(t => t.id === taskId);
                    modal.title.textContent = 'Editar Tarea';
                    modal.saveBtn.textContent = 'Guardar';
                    modal.idInput.value = task.id;
                    modal.nameInput.value = task.title;
                    modal.projectSelect.value = task.project || 'none';
                    modal.descriptionInput.value = task.description;
                    modal.dateInput.value = task.dueDate || '';
                    modal.calendarCheckbox.checked = task.addToCalendar;
                    modal.form.querySelector(`input[name="priority"][value="${task.priority}"]`).checked = true;
                } else {
                    modal.title.textContent = 'Crear Nueva Tarea';
                    modal.saveBtn.textContent = 'Crear';
                    modal.idInput.value = '';
                    modal.form.querySelector('input[name="priority"][value="medium"]').checked = true;
                    if (dateString) {
                        modal.dateInput.value = dateString;
                        modal.calendarCheckbox.checked = true;
                    }
                }
                ModalManager.open(modal);
            },            handleTaskFormSubmit(e) {
                e.preventDefault();
                const modal = DOM.taskModal;
                UIManager.setButtonLoading(modal.saveBtn, true);
    
                const id = modal.idInput.value;
                const taskData = {
                    id: id || `task-${Date.now()}`,
                    title: modal.nameInput.value,
                    description: modal.descriptionInput.value,
                    dueDate: modal.dateInput.value || null,
                    addToCalendar: modal.calendarCheckbox.checked,
                    project: modal.projectSelect.value === 'none' ? null : modal.projectSelect.value,
                    priority: modal.form.querySelector('input[name="priority"]:checked').value,
                    completed: false,
                    createdAt: Date.now(),
                    completedAt: null
                };

                if (id) {
                    const taskIndex = AppState.tasks.findIndex(t => t.id === id);
                    AppState.tasks[taskIndex] = { ...AppState.tasks[taskIndex], ...taskData };
                } else {
                    taskData.status = 'todo';
                    AppState.tasks.push(taskData);
                }
                
                DataService.save().catch(error => {
                    if (IS_DEV) {
                        Logger.error(error);
                    }
                }); // Guardar sin bloquear
                
                // ‚ú® NUEVO: Invalidar cache de tareas
                this.invalidateTasksCache();
                
                UIManager.renderTasksDebounced();
                UIManager.renderDashboardDebounced();
                UIManager.renderProjectSummary();
                UIManager.renderCalendarDebounced();
                this.updateNotificationIndicator();
                UIManager.setButtonLoading(modal.saveBtn, false);
                ModalManager.close(modal);
            },
    
            handleDeleteTask(taskId) {
                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = 'Eliminar Tarea';
                DOM.confirmModal.message.textContent = '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', async () => {
                    // Eliminar de AppState local
                    AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
                    
                    // Eliminar de Firebase/localStorage usando el nuevo m√©todo
                    await window.dataManager.deleteData('tasks', taskId);
                    
                    // ‚ú® NUEVO: Invalidar cache de tareas
                    this.invalidateTasksCache();
                    
                    // Actualizar UI
                    UIManager.renderTasks();
                    UIManager.renderDashboard();
                    UIManager.renderProjectSummary();
                    UIManager.renderCalendar();
                    this.updateNotificationIndicator();
                    ModalManager.close(DOM.confirmModal);
                }, { once: true });
            },

            handleDeleteProject(projectId) {
                const project = AppState.projects.find(p => p.id === projectId);
                if (!project) return;

                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = `Eliminar Proyecto: ${project.name}`;
                DOM.confirmModal.message.textContent = 'Todas las tareas asociadas a este proyecto tambi√©n ser√°n eliminadas. Esta acci√≥n no se puede deshacer.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', async () => {
                    // Eliminar de AppState local
                    AppState.projects = AppState.projects.filter(p => p.id !== projectId);
                    const tasksToDelete = AppState.tasks.filter(t => t.project === projectId || t.project === project.name);
                    AppState.tasks = AppState.tasks.filter(t => t.project !== projectId && t.project !== project.name);
                    
                    // Eliminar proyecto de Firebase/localStorage
                    await window.dataManager.deleteData('projects', projectId);
                    
                    // Eliminar tareas asociadas
                    for (const task of tasksToDelete) {
                        await window.dataManager.deleteData('tasks', task.id);
                    }
                    
                    // Actualizar UI
                    this.renderInitialUI();
                    this.updateNotificationIndicator();
                    ModalManager.close(DOM.confirmModal);
                }, { once: true });
            },

            // Funciones para Mobile Task Management
            openMobileTaskActionsModal(taskId) {
                const modal = document.getElementById('mobile-task-actions-modal');
                if (!modal) return;

                modal.dataset.currentTaskId = taskId;
                modal.classList.remove('hidden');
                
                // Animar la entrada del modal
                setTimeout(() => {
                    const modalContent = modal.querySelector('div > div');
                    if (modalContent) {
                        modalContent.style.transform = 'translateY(0)';
                    }
                }, 10);
            },

            closeMobileTaskActionsModal() {
                const modal = document.getElementById('mobile-task-actions-modal');
                if (!modal) return;

                const modalContent = modal.querySelector('div > div');
                if (modalContent) {
                    modalContent.style.transform = 'translateY(100%)';
                }

                setTimeout(() => {
                    modal.classList.add('hidden');
                    delete modal.dataset.currentTaskId;
                }, 200);
            },

            toggleMobileSection(section) {
                const header = document.querySelector(`[data-section="${section}"]`);
                const content = header?.parentElement.querySelector('.mobile-task-content');
                const chevron = header?.querySelector('.mobile-chevron');
                
                if (!content || !chevron) return;

                const isExpanded = !content.classList.contains('hidden');
                
                if (isExpanded) {
                    // Collapse
                    content.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    // Expand
                    content.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                }
            },

            openMoveTaskModal(taskId) {
                const task = AppState.tasks.find(t => t.id === taskId);
                if (!task) return;

                const currentStatus = task.completed ? 'completed' : (task.status || 'todo');
                const modal = document.getElementById('mobile-move-task-modal');
                const container = document.getElementById('move-options-container');
                
                if (!modal || !container) return;

                // Generar opciones din√°micamente
                const statusOptions = {
                    todo: { name: 'Por Hacer', icon: 'circle', color: 'text-blue-400', bgColor: 'hover:bg-blue-400/10' },
                    doing: { name: 'En Progreso', icon: 'play-circle', color: 'text-yellow-400', bgColor: 'hover:bg-yellow-400/10' },
                    completed: { name: 'Completado', icon: 'check-circle', color: 'text-green-400', bgColor: 'hover:bg-green-400/10' }
                };

                // Limpiar opciones anteriores
                container.innerHTML = '';

                // Agregar solo las opciones disponibles (excluir estado actual)
                Object.entries(statusOptions).forEach(([status, config]) => {
                    if (status !== currentStatus) {
                        const button = document.createElement('button');
                        button.className = `w-full flex items-center px-4 py-3 text-left ${config.bgColor} rounded-lg transition-colors`;
                        button.innerHTML = `
                            <i data-feather="${config.icon}" class="w-5 h-5 mr-3 ${config.color}"></i>
                            <span>${config.name}</span>
                        `;
                        button.addEventListener('click', () => {
                            this.moveTaskToStatus(taskId, status);
                        });
                        container.appendChild(button);
                    }
                });

                // Mostrar modal
                modal.dataset.currentTaskId = taskId;
                modal.classList.remove('hidden');
                
                // Animar entrada
                setTimeout(() => {
                    const modalContent = modal.querySelector('div > div');
                    if (modalContent) {
                        modalContent.style.transform = 'translateY(0)';
                    }
                }, 10);

                // Actualizar iconos
                IconUtils.safeFeatherReplace();
            },

            closeMoveTaskModal() {
                const modal = document.getElementById('mobile-move-task-modal');
                if (!modal) return;

                const modalContent = modal.querySelector('div > div');
                if (modalContent) {
                    modalContent.style.transform = 'translateY(100%)';
                }

                setTimeout(() => {
                    modal.classList.add('hidden');
                    delete modal.dataset.currentTaskId;
                }, 200);
            },

            async moveTaskToStatus(taskId, newStatus) {
                const task = AppState.tasks.find(t => t.id === taskId);
                if (!task) return;

                // Actualizar estado de la tarea
                if (newStatus === 'completed') {
                    task.completed = true;
                    task.status = 'completed';
                } else {
                    task.completed = false;
                    task.status = newStatus;
                }

                // Guardar en base de datos
                await window.dataManager.saveData('tasks', taskId, task);

                // ‚ú® NUEVO: Invalidar cache de tareas
                this.invalidateTasksCache();

                // Cerrar modales
                this.closeMoveTaskModal();
                this.closeMobileTaskActionsModal();

                // Actualizar UI
                UIManager.renderTasks();
                UIManager.renderDashboard();
                UIManager.renderProjectSummary();
                UIManager.renderCalendar();
                this.updateNotificationIndicator();

                // Mostrar notificaci√≥n
                const statusNames = {
                    todo: 'Por Hacer',
                    doing: 'En Progreso', 
                    completed: 'Completado'
                };
                this.showNotification(`Tarea movida a ${statusNames[newStatus]}`, 'success');
            },

            // ‚ú® FUNCI√ìN: Alternar completado de tarea
            async toggleTaskCompletion(taskId) {
                const task = AppState.tasks.find(t => t.id === taskId);
                if (!task) return;

                // Alternar estado de completado
                task.completed = !task.completed;
                task.status = task.completed ? 'completed' : 'todo';
                task.completedAt = task.completed ? Date.now() : null;

                try {
                    // Guardar en base de datos
                    await window.dataManager.saveData('tasks', taskId, task);
                    
                    // Invalidar cache de tareas
                    this.invalidateTasksCache();
                    
                    // Actualizar UI
                    UIManager.renderTasks();
                    UIManager.renderDashboard();
                    UIManager.renderCalendar();
                    this.updateNotificationIndicator();

                    // Mostrar notificaci√≥n
                    const message = task.completed ? 'Tarea completada' : 'Tarea marcada como pendiente';
                    this.showNotification(message, 'success');
                    
                    // Refrescar modal del calendario si est√° abierto
                    if (!DOM.calendarDayModal.el.classList.contains('hidden')) {
                        this.openCalendarDayModal(AppState.selectedCalendarDate);
                    }
                } catch (error) {
                    // Revertir cambio si fall√≥
                    task.completed = !task.completed;
                    task.status = task.completed ? 'completed' : 'todo';
                    task.completedAt = task.completed ? Date.now() : null;
                    
                    console.error('Error al actualizar tarea:', error);
                    this.showNotification('Error al actualizar la tarea', 'error');
                }
            },

            duplicateTask(taskId) {
                const originalTask = AppState.tasks.find(t => t.id === taskId);
                if (!originalTask) return;

                const duplicatedTask = {
                    ...originalTask,
                    id: Utils.generateId(),
                    title: `${originalTask.title} (Copia)`,
                    created: new Date().toISOString()
                };

                AppState.tasks.push(duplicatedTask);
                
                // Guardar en base de datos
                window.dataManager.saveData('tasks', duplicatedTask.id, duplicatedTask);
                
                // Actualizar UI
                UIManager.renderTasks();
                UIManager.renderDashboard();
                UIManager.renderProjectSummary();
                UIManager.renderCalendar();
                this.updateNotificationIndicator();

                this.showNotification('Tarea duplicada exitosamente', 'success');
            },
    
            handleProjectFormSubmit(e) {
                e.preventDefault();
                const modal = DOM.projectModal;
                UIManager.setButtonLoading(modal.saveBtn, true);
    
                const newProject = {
                    id: `proj-${Date.now()}`,
                    name: modal.nameInput.value,
                };
                AppState.projects.push(newProject);
                DataService.save().catch(error => {
                    if (IS_DEV) {
                        Logger.error(error);
                    }
                });
                UIManager.renderProjectFilters();
                UIManager.renderProjectSummary();
                UIManager.setButtonLoading(modal.saveBtn, false);
                ModalManager.close(modal);
            },
            
            // ‚ú® FUNCI√ìN SIMPLIFICADA: Modal del calendario
            openCalendarDayModal(dateString) {
                AppState.selectedCalendarDate = dateString;
                const date = new Date(dateString + 'T00:00:00');
                const modal = DOM.calendarDayModal;
                
                // Formatear fecha
                const dayNumber = date.getDate();
                const monthName = date.toLocaleDateString('es-ES', { month: 'long' });
                const weekday = date.toLocaleDateString('es-ES', { weekday: 'long' });
                
                // Actualizar t√≠tulos
                const titleText = `${dayNumber} de ${monthName} - ${weekday}`;
                if (modal.mobileTitle) modal.mobileTitle.textContent = titleText;
                if (modal.desktopTitle) modal.desktopTitle.textContent = titleText;
                
                // Obtener tareas del d√≠a
                const tasksForDay = AppState.tasks.filter(t => 
                    t.dueDate && new Date(t.dueDate).toDateString() === date.toDateString()
                );
                
                // Renderizar contenido
                this.renderCalendarModalContent(tasksForDay, dateString);
                
                // Mostrar modal
                modal.el.classList.remove('hidden');
                IconUtils.safeFeatherReplace();
            },
            
            renderCalendarModalContent(tasks, dateString) {
                const modal = DOM.calendarDayModal;
                
                if (tasks.length > 0) {
                    // Renderizar lista de tareas con dise√±o completo
                    const taskList = tasks.map(task => {
                        // Obtener nombre del proyecto real
                        const project = AppState.projects.find(p => p.id === task.project);
                        const projectName = project ? project.name : null;
                        
                        // Mapear prioridades correctamente en espa√±ol
                        const priorityMap = {
                            'high': 'Alta',
                            'medium': 'Media', 
                            'low': 'Baja'
                        };
                        const priorityText = priorityMap[task.priority] || 'Media';
                        
                        return `
                        <div class="p-4 border-l-4 ${task.priority === 'high' ? 'border-red-500 bg-red-50 dark:bg-red-900/20' : 
                                                    task.priority === 'medium' ? 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20' : 
                                                    'border-green-500 bg-green-50 dark:bg-green-900/20'} rounded-r-lg mb-3">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h4 class="font-semibold ${task.completed ? 'line-through text-gray-500' : 'text-theme-primary'}">${task.title}</h4>
                                        ${task.completed ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Completada</span>' : ''}
                                    </div>
                                    ${task.description ? '<p class="text-sm text-gray-600 dark:text-gray-400 mb-2">' + task.description + '</p>' : ''}
                                    <div class="flex items-center gap-3 text-xs">
                                        <span class="flex items-center gap-1 ${task.priority === 'high' ? 'text-red-600' : 
                                                                              task.priority === 'medium' ? 'text-yellow-600' : 
                                                                              'text-green-600'}">
                                            <i data-feather="${task.priority === 'high' ? 'alert-triangle' : 
                                                             task.priority === 'medium' ? 'minus-circle' : 
                                                             'circle'}" class="w-3 h-3"></i>
                                            ${priorityText} Prioridad
                                        </span>
                                        ${projectName ? '<span class="text-blue-600">‚Ä¢ ' + projectName + '</span>' : ''}
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 ml-4">
                                    <button onclick="App.openTaskModal('${task.id}', null, false, true)" 
                                            class="p-1.5 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors" 
                                            title="Editar tarea">
                                        <i data-feather="edit" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="App.toggleTaskCompletion('${task.id}')" 
                                            class="p-1.5 rounded-full ${task.completed ? 'bg-red-100 text-red-600 hover:bg-red-200' : 'bg-green-100 text-green-600 hover:bg-green-200'} transition-colors"
                                            title="${task.completed ? 'Marcar como pendiente' : 'Marcar como completada'}">
                                        <i data-feather="${task.completed ? 'x-circle' : 'check-circle'}" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                    
                    if (modal.mobileTasks) modal.mobileTasks.innerHTML = taskList;
                    if (modal.desktopTasks) modal.desktopTasks.innerHTML = taskList;
                } else {
                    // Estado vac√≠o
                    const emptyContent = `
                        <div class="text-center py-8">
                            <i data-feather="calendar" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">No hay tareas para este d√≠a</p>
                            <button onclick="App.createTaskForDate('${dateString}')" 
                                    class="px-4 py-2 bg-theme-primary text-white rounded-lg hover:bg-opacity-90">
                                <i data-feather="plus" class="w-4 h-4 inline mr-2"></i>
                                Crear tarea
                            </button>
                        </div>
                    `;
                    
                    if (modal.mobileTasks) modal.mobileTasks.innerHTML = emptyContent;
                    if (modal.desktopTasks) modal.desktopTasks.innerHTML = emptyContent;
                }
            },
            
            createTaskForDate(dateString) {
                // Cerrar modal
                DOM.calendarDayModal.el.classList.add('hidden');
                
                // Ir a la secci√≥n de tareas usando funci√≥n global
                const navigate = (sectionId) => {
                    DOM.sections.forEach(s => s.classList.add('hidden'));
                    document.getElementById(sectionId).classList.remove('hidden');
                    
                    [...DOM.navButtons, ...DOM.mobileNavButtons].forEach(btn => {
                        btn.classList.toggle('bg-theme-primary', btn.dataset.section === sectionId);
                        btn.classList.toggle('text-white', btn.dataset.section === sectionId);
                    });
                    DOM.mobileMenu.classList.add('hidden');
                };
                
                navigate('tasks');
                
                // Abrir modal de crear tarea con fecha preseleccionada
                setTimeout(() => {
                    App.openTaskModal(null, dateString);
                }, 300);
            },
            
            closeCalendarModal() {
                DOM.calendarDayModal.el.classList.add('hidden');
            },

            // ‚ú® FASE 2: Descompletar tarea desde el calendario
            async uncompleteTaskFromCalendar(taskId) {
                const task = AppState.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                // Actualizar tarea
                task.completed = false;
                task.status = 'todo';
                task.completedAt = null;
                
                // Guardar en base de datos
                try {
                    await window.dataManager.saveData('tasks', taskId, task);
                    
                    // ‚ú® NUEVO: Invalidar cache de tareas
                    this.invalidateTasksCache();
                    
                    // Actualizar UI
                    UIManager.renderTasks();
                    UIManager.renderDashboard();
                    UIManager.renderCalendar();
                    this.updateNotificationIndicator();
                    
                    // Mostrar notificaci√≥n
                    this.showNotification('Tarea marcada como pendiente', 'info');
                    
                    // Refrescar modal si est√° abierto
                    if (!DOM.calendarDayModal.el.classList.contains('hidden')) {
                        this.openCalendarDayModal(AppState.selectedCalendarDate);
                    }
                } catch (error) {
                    console.error('Error al descompletar tarea:', error);
                    this.showNotification('Error al actualizar la tarea', 'error');
                }
            },

            // ‚ú® FASE 2: Duplicar tarea desde el calendario
            async duplicateTaskFromCalendar(taskId) {
                const originalTask = AppState.tasks.find(t => t.id === taskId);
                if (!originalTask) return;

                const duplicatedTask = {
                    ...originalTask,
                    id: `task-${Date.now()}`,
                    title: `${originalTask.title} (Copia)`,
                    completed: false,
                    status: 'todo',
                    createdAt: Date.now(),
                    completedAt: null
                };

                // A√±adir a AppState
                AppState.tasks.push(duplicatedTask);
                
                try {
                    // Guardar en base de datos
                    await window.dataManager.saveData('tasks', duplicatedTask.id, duplicatedTask);
                    
                    // Invalidar cache de tareas
                    this.invalidateTasksCache();
                    
                    // Actualizar UI
                    UIManager.renderTasks();
                    UIManager.renderDashboard();
                    UIManager.renderProjectSummary();
                    UIManager.renderCalendar();
                    this.updateNotificationIndicator();

                    this.showNotification('Tarea duplicada exitosamente', 'success');
                    
                    // Refrescar modal si est√° abierto
                    if (!DOM.calendarDayModal.el.classList.contains('hidden')) {
                        this.openCalendarDayModal(AppState.selectedCalendarDate);
                    }
                } catch (error) {
                    // Remover de AppState si fall√≥ el guardado
                    AppState.tasks = AppState.tasks.filter(t => t.id !== duplicatedTask.id);
                    console.error('Error al duplicar tarea:', error);
                    this.showNotification('Error al duplicar la tarea', 'error');
                }
            },

            // ‚ú® NUEVO: Navegar entre d√≠as en el modal de calendario
            navigateCalendarDay(direction) {
                if (!AppState.selectedCalendarDate) return;
                
                const currentDate = new Date(AppState.selectedCalendarDate + 'T00:00:00');
                currentDate.setDate(currentDate.getDate() + direction);
                
                const newDateString = currentDate.toISOString().split('T')[0];
                this.openCalendarDayModal(newDateString);
            },
            
            // ‚ú® FASE 3: Configurar gestos t√°ctiles para m√≥vil
            setupMobileGestures() {
                const modal = DOM.calendarDayModal.el;
                let startX = 0;
                let startY = 0;
                let endX = 0;
                let endY = 0;
                let isSwipeEnabled = false;
                
                // Detectar inicio del touch
                modal.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        isSwipeEnabled = true;
                    }
                }, { passive: true });
                
                // Detectar movimiento del touch
                modal.addEventListener('touchmove', (e) => {
                    if (!isSwipeEnabled || e.touches.length !== 1) return;
                    
                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const deltaX = Math.abs(currentX - startX);
                    const deltaY = Math.abs(currentY - startY);
                    
                    // Si el movimiento vertical es mayor, cancelar swipe horizontal
                    if (deltaY > deltaX) {
                        isSwipeEnabled = false;
                    }
                }, { passive: true });
                
                // Detectar fin del touch y procesar swipe
                modal.addEventListener('touchend', (e) => {
                    if (!isSwipeEnabled) return;
                    
                    endX = e.changedTouches[0].clientX;
                    endY = e.changedTouches[0].clientY;
                    
                    const deltaX = endX - startX;
                    const deltaY = Math.abs(endY - startY);
                    const minSwipeDistance = 50; // Distancia m√≠nima para considerar swipe
                    const maxVerticalDistance = 100; // M√°xima distancia vertical permitida
                    
                    // Verificar si es un swipe horizontal v√°lido
                    if (Math.abs(deltaX) > minSwipeDistance && deltaY < maxVerticalDistance) {
                        if (deltaX > 0) {
                            // Swipe derecha - d√≠a anterior
                            this.navigateCalendarDay(-1);
                        } else {
                            // Swipe izquierda - d√≠a siguiente
                            this.navigateCalendarDay(1);
                        }
                        
                        // Feedback h√°ptico si est√° disponible
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }
                    
                    isSwipeEnabled = false;
                }, { passive: true });
                
                // Prevenir scroll horizontal en el modal
                modal.addEventListener('touchmove', (e) => {
                    const target = e.target.closest('#calendar-day-tasks');
                    if (!target) {
                        // Solo prevenir si no es en el √°rea de scroll de tareas
                        if (Math.abs(endX - startX) > Math.abs(endY - startY)) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });
            },
            
            // ‚ú® FASE 3: Optimizaciones de performance para m√≥vil
            setupMobileOptimizations() {
                // Lazy loading de iconos
                const observerOptions = {
                    root: null,
                    rootMargin: '50px',
                    threshold: 0.1
                };
                
                const iconObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            IconUtils.safeFeatherReplace(entry.target);
                            iconObserver.unobserve(entry.target);
                        }
                    });
                }, observerOptions);
                
                // Observar modal cuando se abre
                const modal = DOM.calendarDayModal.el;
                iconObserver.observe(modal);
                
                // Optimizar scroll performance
                let ticking = false;
                const mobileTasksContainer = DOM.calendarDayModal.mobileTasks;
                const desktopTasksContainer = DOM.calendarDayModal.desktopTasks;
                
                // Agregar listeners de scroll para ambos contenedores
                [mobileTasksContainer, desktopTasksContainer].forEach(container => {
                    if (container) {
                        container.addEventListener('scroll', () => {
                            if (!ticking) {
                                requestAnimationFrame(() => {
                                    // Aqu√≠ se pueden a√±adir optimizaciones de scroll si es necesario
                                    ticking = false;
                                });
                                ticking = true;
                            }
                        }, { passive: true });
                    }
                });
                
                // Mejorar performance de animaciones en m√≥vil
                if (window.DeviceMotionEvent) {
                    // Reducir animaciones en dispositivos de gama baja
                    const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
                    if (reducedMotion.matches) {
                        document.documentElement.style.setProperty('--animation-duration', '0.1s');
                    }
                }
            },

            // ‚ú® MEJORADO: Cache para tareas por d√≠a
            _dailyTasksCache: new Map(),
            _cacheVersion: 0,

            // ‚ú® MEJORADO: Limpiar cache cuando las tareas cambien
            invalidateTasksCache() {
                this._cacheVersion++;
                this._dailyTasksCache.clear();
                console.log('üîÑ Cache de tareas invalidado');
            },

            // ‚ú® MEJORADO: Obtener tareas para un d√≠a con cache
            getTasksForDay(date) {
                const dateString = date.toDateString();
                const cacheKey = `${dateString}_${this._cacheVersion}`;
                
                if (this._dailyTasksCache.has(cacheKey)) {
                    return this._dailyTasksCache.get(cacheKey);
                }
                
                const tasksForDay = AppState.tasks.filter(t => {
                    if (!t.dueDate) return false;
                    try {
                        return new Date(t.dueDate).toDateString() === dateString;
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Fecha inv√°lida en tarea:', t.id, t.dueDate);
                        return false;
                    }
                });
                
                this._dailyTasksCache.set(cacheKey, tasksForDay);
                return tasksForDay;
            },
    
            getHighestPriorityForDay(date) {
                const tasksForDay = this.getTasksForDay(date);
                if (tasksForDay.length === 0) return null;
                
                // Optimizaci√≥n: buscar directamente la prioridad m√°s alta
                for (const task of tasksForDay) {
                    if (task.priority === 'high') return 'high';
                }
                for (const task of tasksForDay) {
                    if (task.priority === 'medium') return 'medium';
                }
                return 'low';
            },

            // ‚ú® MEJORADO: Informaci√≥n completa del d√≠a
            getDayInfo(date) {
                const tasksForDay = this.getTasksForDay(date);
                const total = tasksForDay.length;
                const completed = tasksForDay.filter(t => t.completed).length;
                const pending = total - completed;
                const highestPriority = this.getHighestPriorityForDay(date);
                
                return {
                    total,
                    completed,
                    pending,
                    highestPriority,
                    tasks: tasksForDay,
                    hasTasksToday: total > 0
                };
            },

            // Transici√≥n desde login hacia la app principal
            async transitionToApp(user) {
                // Actualizar informaci√≥n del usuario
                AppState.user.name = user.displayName || user.email || 'Usuario';
                DOM.userName.textContent = AppState.user.name;
                
                // Actualizar estado de autenticaci√≥n
                AppState.user.isGuest = user.isGuest || false;
                AppState.user.uid = user.uid;
                
                // Inicializar sistema de almacenamiento con usuario disponible
                await window.dataManager.initialize();
                
                // Configurar listeners en tiempo real
                this.setupRealtimeListeners();
                
                // Configurar listeners de conexi√≥n
                this.setupConnectionListeners();
                this.updateConnectionStatus();
                
                // Transici√≥n visual
                DOM.loginScreen.classList.add('opacity-0');
                setTimeout(() => {
                    DOM.loginScreen.classList.add('hidden');
                    DOM.mainApp.classList.remove('hidden');
                    setTimeout(async () => {
                        DOM.mainApp.classList.remove('opacity-0');
                        await DataService.load(); // Cargar datos del usuario ANTES del renderizado
                        UIManager.renderDashboard();
                        UIManager.renderTasks();
                        UIManager.renderCalendar();
                    }, 50);
                }, 1000);
            },

            // Configurar listeners en tiempo real para sincronizaci√≥n
            setupRealtimeListeners() {
                if (IS_DEV) {
                    Logger.firebase('Configurando listeners en tiempo real...');
                }
                
                // Listener para tareas
                window.dataManager.listenToData('tasks', (tasks) => {
                    if (tasks && Array.isArray(tasks)) {
                        AppState.tasks = tasks;
                        UIManager.renderTasksDebounced();
                        UIManager.renderDashboardDebounced();
                        UIManager.renderProjectSummary();
                        UIManager.renderCalendarDebounced();
                        if (IS_DEV) {
                            Logger.firebase('Tareas sincronizadas');
                        }
                    }
                });
                
                // Listener para proyectos
                window.dataManager.listenToData('projects', (projects) => {
                    if (projects && Array.isArray(projects)) {
                        AppState.projects = projects;
                        UIManager.renderProjectFilters();
                        UIManager.renderProjectSummary();
                        if (IS_DEV) {
                            Logger.firebase('Proyectos sincronizados');
                        }
                    }
                });
                
                // Listener para configuraci√≥n de usuario
                window.dataManager.listenToData('user_config', (userConfig) => {
                    if (userConfig) {
                        const oldTheme = AppState.user.theme;
                        Object.assign(AppState.user, userConfig);
                        
                        // Actualizar UI si cambi√≥ el tema
                        if (oldTheme !== AppState.user.theme) {
                            UIManager.applyTheme();
                        }
                        
                        // Actualizar nombre en dashboard
                        DOM.userName.textContent = AppState.user.name || 'Usuario';
                        if (IS_DEV) {
                            Logger.firebase('Configuraci√≥n sincronizada');
                        }
                    }
                });
                
                if (IS_DEV) {
                    Logger.firebase('Listeners en tiempo real configurados');
                }
            },

            // Configurar listeners de conexi√≥n
            setupConnectionListeners() {
                window.addEventListener('online', () => this.updateConnectionStatus());
                window.addEventListener('offline', () => this.updateConnectionStatus());
                
                // Escuchar cambios en la cola de sincronizaci√≥n
                if (window.dataManager?.on) {
                    window.dataManager.on('syncQueueChange', () => this.updateConnectionStatus());
                }
                
                if (IS_DEV) {
                    Logger.firebase('Listeners de conexi√≥n configurados');
                }
            },

            // Actualizar indicador de estado de conexi√≥n
            updateConnectionStatus() {
                const isOnline = navigator.onLine;
                const isGuest = AppState.user.isGuest;
                const syncQueue = window.dataManager?.syncQueue?.length || 0;
                
                if (isGuest) {
                    DOM.statusIndicator.className = 'w-2 h-2 rounded-full bg-gray-500';
                    DOM.statusText.textContent = 'Modo local';
                } else if (!isOnline) {
                    DOM.statusIndicator.className = 'w-2 h-2 rounded-full bg-red-500';
                    DOM.statusText.textContent = 'Sin conexi√≥n';
                } else if (syncQueue > 0) {
                    DOM.statusIndicator.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                    DOM.statusText.textContent = 'Sincronizando...';
                } else {
                    DOM.statusIndicator.className = 'w-2 h-2 rounded-full bg-green-500';
                    DOM.statusText.textContent = 'En l√≠nea';
                }
            },

            // Sistema de notificaciones
            showNotification(message, type = 'info', duration = 3000) {
                // Crear elemento de notificaci√≥n si no existe
                let notification = document.getElementById('app-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'app-notification';
                    notification.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300';
                    document.body.appendChild(notification);
                }

                // Configurar estilos seg√∫n el tipo
                const typeStyles = {
                    success: 'bg-green-600 text-white',
                    error: 'bg-red-600 text-white',
                    warning: 'bg-yellow-600 text-white',
                    info: 'bg-blue-600 text-white'
                };

                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-transform duration-300 ${typeStyles[type] || typeStyles.info}`;
                notification.textContent = message;

                // Mostrar notificaci√≥n
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);

                // Ocultar notificaci√≥n despu√©s del tiempo especificado
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            },

            // Mostrar estad√≠sticas de almacenamiento
            showStorageStats() {
                if (!window.dataManager) return;
                
                const stats = window.dataManager.getStorageStats();
                const health = window.dataManager.getHealthCheck();
                
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                const statsModal = document.createElement('div');
                statsModal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
                statsModal.innerHTML = `
                    <div class="bg-theme-card rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-purple-400">Estad√≠sticas de Almacenamiento</h3>
                            <button id="close-stats" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-theme/30 p-4 rounded-lg">
                                <h4 class="font-semibold text-purple-300 mb-2">Estado General</h4>
                                <p><span class="text-gray-400">Modo:</span> ${stats.mode === 'local' ? 'Local' : 'Nube'}</p>
                                <p><span class="text-gray-400">Conexi√≥n:</span> ${stats.isOnline ? 'En l√≠nea' : 'Sin conexi√≥n'}</p>
                                <p><span class="text-gray-400">Cola de sincronizaci√≥n:</span> ${stats.syncQueueSize} elementos</p>
                                <p><span class="text-gray-400">√öltima sincronizaci√≥n:</span> ${stats.lastSync}</p>
                            </div>
                            
                            <div class="bg-theme/30 p-4 rounded-lg">
                                <h4 class="font-semibold text-purple-300 mb-2">Uso de Almacenamiento</h4>
                                <p><span class="text-gray-400">Total de elementos:</span> ${stats.totalItems}</p>
                                <p><span class="text-gray-400">Espacio local usado:</span> ${formatBytes(stats.localStorageUsage)}</p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-purple-300 mb-3">Colecciones</h4>
                            ${Object.entries(stats.collections).map(([name, data]) => `
                                <div class="bg-theme/20 p-3 rounded mb-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                                        <span class="text-sm text-gray-400">${data.itemCount} elementos</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Tama√±o: ${formatBytes(data.sizeBytes)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="text-xs text-gray-500">
                            <p>Actualizado: ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(statsModal);
                
                // Cerrar modal
                document.getElementById('close-stats').onclick = () => {
                    statsModal.remove();
                };
                
                statsModal.onclick = (e) => {
                    if (e.target === statsModal) {
                        statsModal.remove();
                    }
                };
            },

            exportData() {
                const now = new Date();
                const pad = (num) => num.toString().padStart(2, '0');
                const dateStamp = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}`;
                const timeStamp = `${pad(now.getHours())}${pad(now.getMinutes())}`;
                const fileName = `orion_backup_${dateStamp}-${timeStamp}.json`;

                const dataStr = JSON.stringify(AppState, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', fileName);
                linkElement.click();
            },
    
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        // Validaci√≥n m√°s robusta
                        if (importedState && typeof importedState.user === 'object' && Array.isArray(importedState.tasks) && Array.isArray(importedState.projects) && typeof importedState.filters === 'object') {
                            Object.assign(AppState, importedState);
                            AppState.currentDate = new Date(); // Resetear siempre la fecha actual
                            DataService.save().catch(error => {
                                if (IS_DEV) {
                                    Logger.error(error);
                                }
                            });
                            this.renderInitialUI();
                            this.openInfoModal({ title: '√âxito', message: '¬°Datos importados correctamente!', type: 'success' });
                        } else {
                             this.openInfoModal({ title: 'Error de Formato', message: 'El archivo no parece ser un backup v√°lido de ORION.', type: 'error' });
                        }
                    } catch (error) {
                        this.openInfoModal({ title: 'Error de Archivo', message: `No se pudo leer el archivo JSON. (${error.message})`, type: 'error' });
                    }
                };
                reader.readAsText(file);
                DOM.importJsonInput.value = '';
            },
    
            deleteAllData() {
                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = 'Borrar todos los datos';
                DOM.confirmModal.message.textContent = '¬°Atenci√≥n! Esto eliminar√° permanentemente todas tus tareas y proyectos.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', () => {
                    localStorage.removeItem('orionAppState_v2');
                    window.location.reload(); // La forma m√°s sencilla de resetear todo a su estado inicial
                }, { once: true });
            },
    
            async logout() {
                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = 'Cerrar Sesi√≥n';
                DOM.confirmModal.message.textContent = 'Esto te redirigir√° a la pantalla de bienvenida. Tus datos se guardar√°n.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', async () => {
                    try {
                        await window.authManager.signOut();
                        window.location.reload();
                    } catch (error) {
                        if (IS_DEV) {
                            Logger.firebase('Error al cerrar sesi√≥n:', error);
                        }
                        window.location.reload();
                    }
                }, { once: true });
            },

            openInfoModal({ title, message, type = 'info' }) {
                const modal = DOM.infoModal;
                modal.title.textContent = title;
                modal.message.textContent = message;
    
                modal.iconContainer.innerHTML = '';
                modal.iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4';
    
                if (type === 'error') {
                    modal.iconContainer.classList.add('bg-red-100');
                    modal.iconContainer.innerHTML = `<i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>`;
                } else { // 'success' or 'info'
                    modal.iconContainer.classList.add('bg-green-100');
                    modal.iconContainer.innerHTML = `<i data-feather="check-circle" class="h-6 w-6 text-green-600"></i>`;
                }
                IconUtils.safeFeatherReplace();
                ModalManager.open(modal);
            },

            updateStreak() {
                const today = new Date().toDateString();
                if (AppState.user.lastCompletionDate === today) {
                    return; // Ya se complet√≥ una tarea hoy
                }

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (AppState.user.lastCompletionDate === yesterday.toDateString()) {
                    AppState.user.streak = (AppState.user.streak || 0) + 1;
                } else {
                    AppState.user.streak = 1;
                }
                AppState.user.lastCompletionDate = today;
            },

            updateNotificationIndicator(show = true) {
                const today = new Date().toDateString();
                const tasksToday = AppState.tasks.filter(t => t.dueDate && new Date(t.dueDate).toDateString() === today && !t.completed);
                
                const shouldShow = show && tasksToday.length > 0;

                [...DOM.navButtons, ...DOM.mobileNavButtons].forEach(btn => {
                    if (btn.dataset.section === 'dashboard') {
                        let dot = btn.querySelector('.notification-dot');
                        if (shouldShow && !dot) {
                            dot = document.createElement('span');
                            dot.className = 'notification-dot';
                            btn.appendChild(dot);
                        } else if (!shouldShow && dot) {
                            dot.remove();
                        }
                    }
                });
            }
        };

        // -----------------------------------------------------------------------------
        // OPTIMIZACIONES FINALES Y LAZY LOADING  
        // -----------------------------------------------------------------------------
        const FinalOptimizations = {
            // Optimizar feather.replace() calls
            optimizeFeatherReplace() {
                // Solo optimizar si feather ya est√° cargado
                if (window.feather && window.feather.replace) {
                    const originalFeatherReplace = feather.replace;
                    let replaceTimeout;
                    feather.replace = function() {
                        clearTimeout(replaceTimeout);
                        replaceTimeout = setTimeout(() => originalFeatherReplace.call(this), 50);
                    };
                    if (IS_DEV) {
                        Logger.perf('Feather Icons optimizado');
                    }
                } else {
                    // Escuchar el evento featherReady
                    window.addEventListener('featherReady', () => {
                        this.optimizeFeatherReplace();
                    }, { once: true });
                }
            },

            // Precargar recursos cr√≠ticos
            preloadCriticalResources() {
                if ('serviceWorker' in navigator) {
                    // Preparar para PWA en el futuro
                }
            },

            // FASE 4: Mejorar UX con loading states mejorados
            enhanceLoadingStates() {
                // Implementar skeleton loading en navegaci√≥n
                const navigate = (sectionId) => {
                    // Mostrar skeleton antes de cambiar
                    if (sectionId === 'tasks') {
                        UIManager.showSkeletonTasks();
                        setTimeout(() => {
                            UIManager.hideSkeletons();
                            UIManager.renderTasks();
                        }, 200);
                    } else if (sectionId === 'dashboard') {
                        UIManager.showSkeletonDashboard();
                        setTimeout(() => {
                            UIManager.hideSkeletons();
                            UIManager.renderDashboard();
                        }, 200);
                    }
                };
            },

            // FASE 5: Preparar para escalabilidad y PWA completa
            async prepareForScaling() {
                try {
                    // 1. Configurar bundle optimization
                    if (window.bundleManager) {
                        await window.bundleManager.autoLoad();
                        window.bundleManager.setupIntelligentPreloading();
                    }
                    
                    // 2. Implementar bases para PWA optimizada
                    this.setupPWASupport();
                    
                    // 3. Resource optimization
                    if (window.resourceOptimizer) {
                        window.resourceOptimizer.optimizeAssets();
                    }
                    
                    // 4. Error recovery
                    ErrorHandler.reset();
                    
                    if (IS_DEV) {
                        Logger.success('Aplicaci√≥n optimizada con Fase 5 - Bundle optimization');
                        
                        // Reportar m√©tricas en desarrollo
                        setTimeout(() => {
                            if (window.resourceOptimizer) {
                                window.resourceOptimizer.reportMetrics();
                            }
                            if (window.bundleManager) {
                                const stats = window.bundleManager.getStats();
                                Logger.debug('Bundle stats:', stats);
                            }
                        }, 5000);
                    }
                    
                } catch (error) {
                    Logger.error('Error en Fase 5 optimization:', error);
                }
            },

            // PWA Support b√°sico
            setupPWASupport() {
                // Detectar instalaci√≥n offline
                if ('serviceWorker' in navigator) {
                    // Preparado para service worker futuro
                    if (IS_DEV) {
                        console.log('ÔøΩ PWA support detectado');
                    }
                }

                // Detectar si se ejecuta como PWA
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                   window.navigator.standalone === true;
                
                if (isStandalone) {
                    document.body.classList.add('pwa-mode');
                }

                // Install prompt b√°sico
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    deferredPrompt = e;
                    // Podr√≠as mostrar un bot√≥n de instalaci√≥n aqu√≠
                });
            }
        };

        // Aplicar optimizaciones finales
        FinalOptimizations.optimizeFeatherReplace();
        FinalOptimizations.preloadCriticalResources();
        FinalOptimizations.enhanceLoadingStates();
        FinalOptimizations.prepareForScaling();
    
        // Iniciar la aplicaci√≥n
        App.init();
        
        // ‚ú® HACER APP ACCESIBLE GLOBALMENTE para onclick handlers
        window.App = App;
    });
    </script>
    
    <!-- Phase 3 Scripts - Carga al final para asegurar DOM -->
    <script>
        // Verificar y cargar Phase 3 cuando todo est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.IS_DEV) {
                    Logger.debug('Verificando Phase 3 managers...');
                    Logger.debug('AppShellManager:', !!window.AppShellManager);
                    Logger.debug('KeyboardShortcuts:', !!window.KeyboardShortcuts);
                    Logger.debug('GestureHandler:', !!window.GestureHandler);
                    Logger.debug('LoadingStates:', !!window.LoadingStates);
                }
            }, 1000);
        });
    </script>
</body>
</html>
