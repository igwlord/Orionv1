<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORION - Organiza. Evoluciona. Expande tu universo.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        /* Estilos base y configuración de temas con Tailwind */
        :root {
            /* Tema Claro (Light) */
            --bg-light: #F4E9E0; /* Beige */
            --text-light: #4A4A4A;
            --primary-light: #E57373; /* Coral */
            --primary-light-rgb: 229, 115, 115;
            --secondary-light: #A5D6A7; /* Verde Seco */
            --accent-light: #FFB74D; /* Naranja Terracota */
            --card-light: #FFFFFF;
            --border-light: #E0D8D3; /* Un beige más oscuro para el borde */

            /* Tema Oscuro (Dark) */
            --bg-dark: #110F1A; /* Azul Noche profundo */
            --text-dark: #E0E0E0;
            --primary-dark: #C084FC; /* Violeta */
            --primary-dark-rgb: 192, 132, 252;
            --secondary-dark: #F472B6; /* Magenta */
            --accent-dark: #FBBF24; /* Dorado suave */
            --card-dark: #1E1B2E;
            --border-dark: #3A3356;
        }

        /* Aplicación de temas */
        .light {
            background-color: transparent; /* Fondo principal ahora es transparente */
            color: var(--text-light);
        }
        .dark {
            background-color: transparent; /* Fondo principal ahora es transparente */
            color: var(--text-dark);
        }

        /* Clases de utilidad para temas */
        .bg-theme { background-color: var(--bg-light); }
        .dark .bg-theme { background-color: var(--bg-dark); }
        .text-theme-primary { color: var(--primary-light); }
        .dark .text-theme-primary { color: var(--primary-dark); }
        .bg-theme-primary { background-color: var(--primary-light); }
        .dark .bg-theme-primary { background-color: var(--primary-dark); }
        .bg-theme-secondary { background-color: var(--secondary-light); }
        .dark .bg-theme-secondary { background-color: var(--secondary-dark); }
        .bg-theme-accent { background-color: var(--accent-light); }
        .dark .bg-theme-accent { background-color: var(--accent-dark); }
        .bg-theme-card { background-color: var(--card-light); }
        .dark .bg-theme-card { background-color: var(--card-dark); }
        .border-theme { border-color: var(--border-light); }
        .dark .border-theme { border-color: var(--border-dark); }
        
        /* Tipografías */
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
        
        /* Efecto typewriter (solo el cursor) */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--accent-dark); }
        }
        .typewriter-caret {
            border-right: .12em solid var(--accent-dark);
            animation: blink-caret .75s step-end infinite;
        }
        .light .typewriter-caret {
            border-right-color: var(--accent-light);
        }

        /* Estilos para SortableJS */
        .kanban-column .sortable-ghost {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            border: 2px dashed var(--accent-dark);
        }
        .light .kanban-column .sortable-ghost {
            border: 2px dashed var(--accent-light);
        }
        .task-card {
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        
        /* Mejora para el date picker en modo oscuro */
        .dark input[type="date"] {
            color-scheme: dark;
        }

        /* Estilo para spinner de carga */
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        /* Estilos para el Canvas del fondo de estrellas */
        #starfield-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Detrás de todo */
        }
        
        /* Animaciones de bienvenida */
        @keyframes star-glow-in {
            from {
                opacity: 0;
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
                transform: translateY(0);
            }
        }
        
        #welcome-screen h1 span {
            opacity: 0;
            animation: star-glow-in 0.8s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        #welcome-screen #slogan, #welcome-screen #start-btn, #welcome-screen footer {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        /* Animación para el punto de notificación */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }
        }
        .notification-dot {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background-color: var(--accent-dark);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .light .notification-dot {
            background-color: var(--accent-light);
        }
    </style>
</head>
<body class="transition-colors duration-500 bg-theme">
    
    <canvas id="starfield-canvas"></canvas>

    <!-- PANTALLA DE BIENVENIDA -->
    <div id="welcome-screen" class="h-screen w-screen flex flex-col items-center justify-center text-center p-4 bg-transparent transition-opacity duration-1000">
        <div class="flex-grow flex flex-col items-center justify-center">
            <h1 id="main-title" class="text-7xl md:text-9xl font-bold text-white tracking-wider font-display">
                <!-- Las letras se insertarán aquí con JS -->
            </h1>
            <p id="slogan" class="text-lg md:text-xl mt-4 text-gray-300 h-16 md:h-8 flex items-center justify-center"></p>
            <button id="start-btn" class="mt-8 px-8 py-4 bg-theme-primary text-white font-bold rounded-full text-lg hover:scale-105 transform transition-transform duration-300 shadow-lg shadow-purple-500/50">
                Comenzar
            </button>
        </div>
        <footer class="pb-4">
            <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-400 opacity-75 hover:opacity-100 transition-opacity">
                Neptune Studios
            </a>
        </footer>
    </div>

    <!-- CONTENIDO PRINCIPAL DE LA APP -->
    <div id="main-app" class="hidden opacity-0 transition-opacity duration-1000 flex">
        
        <!-- NAVEGACIÓN LATERAL (DOCK EN PC) -->
        <nav id="main-nav" class="hidden md:flex flex-col items-center w-20 bg-theme-card/10 border-r border-theme p-4">
            <div class="font-display text-2xl font-bold text-theme-primary">O</div>
            <div class="space-y-6 mt-6">
                <button data-section="dashboard" class="nav-btn relative p-3 rounded-lg bg-theme-primary text-white"><i data-feather="home"></i></button>
                <button data-section="tasks" class="nav-btn p-3 rounded-lg"><i data-feather="check-square"></i></button>
                <button data-section="calendar" class="nav-btn p-3 rounded-lg"><i data-feather="calendar"></i></button>
                <button data-section="kaizen" class="nav-btn p-3 rounded-lg"><i data-feather="zap"></i></button>
                <button data-section="settings" class="nav-btn p-3 rounded-lg"><i data-feather="settings"></i></button>
            </div>
            <div class="mt-auto">
                 <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-xs text-gray-500 opacity-75 hover:opacity-100 transition-opacity">
                    NS
                </a>
            </div>
        </nav>

        <!-- NAVEGACIÓN SUPERIOR (MOBILE) -->
        <nav id="mobile-nav" class="md:hidden fixed top-0 left-0 right-0 bg-theme-card/80 backdrop-blur-sm border-b border-theme z-40 flex justify-between items-center p-4">
            <div class="font-display text-2xl font-bold text-theme-primary">ORION</div>
            <button id="hamburger-btn" class="p-2"><i data-feather="menu"></i></button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden fixed inset-0 bg-theme/90 backdrop-blur-lg z-50 flex flex-col items-center justify-center">
             <button id="close-mobile-menu" class="absolute top-6 right-6 p-2"><i data-feather="x"></i></button>
             <div class="flex flex-col items-center justify-center flex-grow space-y-8">
                <button data-section="dashboard" class="mobile-nav-btn relative text-2xl">Dashboard</button>
                <button data-section="tasks" class="mobile-nav-btn text-2xl">Tareas</button>
                <button data-section="calendar" class="mobile-nav-btn text-2xl">Calendario</button>
                <button data-section="kaizen" class="mobile-nav-btn text-2xl">Kaizen</button>
                <button data-section="settings" class="mobile-nav-btn text-2xl">Configuración</button>
             </div>
             <footer class="pb-8">
                <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-400 opacity-75 hover:opacity-100 transition-opacity">
                    Neptune Studios
                </a>
             </footer>
        </div>

        <!-- CONTENEDOR DE SECCIONES -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto h-screen mt-16 md:mt-0 pb-24 md:pb-8 bg-theme/80 dark:bg-theme/90 backdrop-blur-sm">
            
            <!-- DASHBOARD -->
            <section id="dashboard" class="app-section">
                <h2 class="text-3xl font-bold mb-2">Hola, <span id="user-name"></span></h2>
                <p class="text-lg text-gray-400 mb-8">¿Qué vas a mejorar hoy?</p>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Tareas para Hoy -->
                        <div class="bg-theme-card p-6 rounded-xl shadow-lg border-2 border-theme-primary">
                            <h3 class="text-2xl font-bold mb-4">Tareas para Hoy</h3>
                            <div id="today-tasks-list" class="space-y-3"></div>
                        </div>
                        <!-- Próximas Tareas -->
                        <div class="bg-theme-card p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold mb-4">Próximas Tareas</h3>
                            <div id="upcoming-tasks-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <!-- Racha de Productividad -->
                    <div class="bg-theme-card p-6 rounded-xl shadow-lg flex flex-col items-center justify-center text-center">
                        <i data-feather="award" class="w-12 h-12 text-theme-accent mb-2"></i>
                        <p class="text-5xl font-bold" id="streak-count">0</p>
                        <p class="text-gray-400">Días de racha</p>
                        <p class="text-xs text-gray-500 mt-4">Completa al menos una tarea cada día para mantener tu racha.</p>
                    </div>
                </div>
            </section>

            <!-- TAREAS -->
            <section id="tasks" class="app-section hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold">Tareas y Proyectos</h2>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <button id="quick-save-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity flex-shrink-0"><i data-feather="save" class="inline-block -mt-1"></i></button>
                        <button id="create-project-btn" class="bg-theme-secondary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity flex-shrink-0"><i data-feather="folder-plus" class="inline-block -mt-1"></i></button>
                        <button id="create-task-btn" class="bg-theme-primary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity flex-shrink-0"><i data-feather="plus" class="inline-block -mt-1"></i> Crear Tarea</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-start md:items-center mb-4 gap-4">
                    <div class="relative w-full md:max-w-xs">
                        <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        <input type="text" id="search-tasks-input" placeholder="Buscar tareas..." class="w-full bg-theme-card/50 border border-theme rounded-lg p-2 pl-10 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                    </div>
                    <select id="project-filter-select" class="w-full md:w-auto bg-theme-card/50 border border-theme rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                        <option value="all">Todos los proyectos</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Columnas Kanban -->
                    <div class="kanban-column bg-theme-card/50 p-4 rounded-lg">
                        <h3 class="font-bold mb-4 text-yellow-400">🟡 Por Hacer</h3>
                        <div id="todo-column" class="min-h-[200px] space-y-4"></div>
                    </div>
                    <div class="kanban-column bg-theme-card/50 p-4 rounded-lg">
                        <h3 class="font-bold mb-4 text-blue-400">🔵 Haciendo</h3>
                        <div id="doing-column" class="min-h-[200px] space-y-4"></div>
                    </div>
                    <div class="kanban-column bg-theme-card/50 p-4 rounded-lg">
                        <h3 class="font-bold mb-4 text-green-400">✅ Completadas</h3>
                        <div id="completed-column" class="min-h-[200px] space-y-4"></div>
                    </div>
                </div>
            </section>

            <!-- CALENDARIO -->
            <section id="calendar" class="app-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Calendario</h2>
                    <button id="goto-today-btn" class="bg-theme-primary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity">Ir a Hoy</button>
                </div>
                <div class="bg-theme-card p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-theme-card"><i data-feather="chevron-left"></i></button>
                        <h3 id="month-year-header" class="text-xl font-bold"></h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-theme-card"><i data-feather="chevron-right"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 border-r border-b border-theme">
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">D</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">L</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">M</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">M</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">J</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">V</div>
                        <div class="text-center font-bold text-gray-400 py-2 border-t border-l border-theme">S</div>
                    </div>
                </div>
            </section>

            <!-- KAIZEN -->
            <section id="kaizen" class="app-section hidden max-w-4xl mx-auto">
                <h2 class="text-4xl font-bold text-center mb-4 font-display text-theme-primary">El Camino Kaizen</h2>
                <p class="text-center text-lg text-gray-400 mb-12">Mejora continua, un pequeño paso a la vez.</p>
                <div class="space-y-8">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="bg-theme-card p-6 rounded-full text-theme-primary"><i data-feather="target" class="w-10 h-10"></i></div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">¿Qué es el método Kaizen?</h3>
                            <p>Kaizen es una filosofía japonesa que se centra en la mejora continua en todos los aspectos de la vida. En lugar de buscar cambios radicales y abruptos, Kaizen propone realizar pequeñas mejoras incrementales de forma constante.</p>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row-reverse items-center gap-6">
                        <div class="bg-theme-card p-6 rounded-full text-theme-primary"><i data-feather="bar-chart-2" class="w-10 h-10"></i></div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">¿Cómo mejora tu productividad?</h3>
                            <p>Al dividir grandes metas en tareas minúsculas (microacciones), se reduce la procrastinación y el agobio. Cada pequeña victoria genera momentum y motivación, creando un ciclo positivo de progreso que, con el tiempo, conduce a resultados extraordinarios.</p>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="bg-theme-card p-6 rounded-full text-theme-primary"><i data-feather="play-circle" class="w-10 h-10"></i></div>
                        <div>
                            <h3 class="text-2xl font-bold mb-2">Aplica microacciones en ORION</h3>
                            <p>Usa la sección de Tareas para crear acciones que te tomen menos de 5 minutos. ¿Quieres leer un libro? Crea una tarea "Leer una página". ¿Quieres aprender a programar? "Ver 2 minutos de un tutorial". La clave es la consistencia.</p>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-12">
                    <button id="try-kaizen-btn" class="bg-theme-primary text-white px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transform transition-transform duration-300">Probar ahora</button>
                </div>
            </section>

            <!-- CONFIGURACIÓN -->
            <section id="settings" class="app-section hidden max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold mb-8">Configuración</h2>
                <div class="space-y-6">
                    <!-- Tema -->
                    <div class="bg-theme-card p-4 rounded-lg">
                        <h3 class="font-bold mb-3">Tema de la Interfaz</h3>
                        <div class="flex items-center space-x-4">
                            <span>Claro</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="theme-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-theme-primary"></div>
                            </label>
                            <span>Oscuro</span>
                        </div>
                    </div>
                    <!-- Perfil -->
                    <div class="bg-theme-card p-4 rounded-lg">
                        <h3 class="font-bold mb-3">Perfil de Usuario</h3>
                        <label for="username-input" class="block text-sm text-gray-400">Nombre de usuario</label>
                        <input type="text" id="username-input" class="w-full bg-theme/50 border border-theme rounded-md p-2 mt-1 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                    </div>
                    <!-- Datos -->
                    <div class="bg-theme-card p-4 rounded-lg">
                        <h3 class="font-bold mb-3">Gestión de Datos</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button id="export-json-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Guardar mis datos</button>
                            <label class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors text-center cursor-pointer">
                                <span>Cargar mis datos</span>
                                <input type="file" id="import-json-input" class="hidden" accept=".json">
                            </label>
                        </div>
                    </div>
                     <!-- Zona de peligro -->
                    <div class="border-2 border-red-500/50 p-4 rounded-lg mt-8">
                        <h3 class="font-bold text-red-400 mb-3">Zona de Peligro</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button id="logout-btn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition-colors">Cerrar Sesión</button>
                            <button id="delete-all-btn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">⚠️ Borrar Todo</button>
                        </div>
                    </div>
                </div>
                 <footer class="mt-12 text-center">
                    <a href="https://neptunestudios.netlify.app/" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 opacity-75 hover:opacity-100 transition-opacity">
                        Neptune Studios
                    </a>
                </footer>
            </section>

        </main>
    </div>

    <!-- MODALES -->
    <div id="modal-container">
        <!-- Modal para Tareas -->
        <div id="task-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-md transform transition-all opacity-0 -translate-y-10" role="dialog" aria-modal="true">
                <h3 id="modal-title" class="text-2xl font-bold mb-6">Crear Nueva Tarea</h3>
                <form id="task-form">
                    <input type="hidden" id="task-id">
                    <div class="mb-4">
                        <label for="task-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre de la tarea</label>
                        <input type="text" id="task-name" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400" required>
                    </div>
                    <div class="mb-4">
                        <label for="task-project" class="block text-sm font-medium text-gray-400 mb-1">Proyecto</label>
                        <select id="task-project" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                           <option value="none">Sin proyecto</option>
                        </select>
                    </div>
                     <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Prioridad</label>
                        <div class="flex justify-around p-1 bg-theme/50 rounded-md border border-theme">
                           <label class="flex-1 text-center cursor-pointer p-1 rounded-md transition-colors"><input type="radio" name="priority" value="low" class="sr-only peer"><span class="peer-checked:bg-green-500 peer-checked:text-white px-2 py-1 rounded-md">Baja</span></label>
                           <label class="flex-1 text-center cursor-pointer p-1 rounded-md transition-colors"><input type="radio" name="priority" value="medium" class="sr-only peer" checked><span class="peer-checked:bg-yellow-500 peer-checked:text-white px-2 py-1 rounded-md">Media</span></label>
                           <label class="flex-1 text-center cursor-pointer p-1 rounded-md transition-colors"><input type="radio" name="priority" value="high" class="sr-only peer"><span class="peer-checked:bg-red-500 peer-checked:text-white px-2 py-1 rounded-md">Alta</span></label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="task-description" class="block text-sm font-medium text-gray-400 mb-1">Descripción</label>
                        <textarea id="task-description" rows="3" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="task-date" class="block text-sm font-medium text-gray-400 mb-1">Fecha</label>
                        <input type="date" id="task-date" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400">
                    </div>
                    <div class="flex items-center mb-6">
                        <input id="task-calendar-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-theme-primary focus:ring-theme-primary">
                        <label for="task-calendar-checkbox" class="ml-2 block text-sm">Agregar al calendario</label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-task-btn" class="px-4 py-2 rounded-md text-gray-400 hover:bg-gray-700">Cancelar</button>
                        <button type="submit" id="save-task-btn" class="px-6 py-2 bg-theme-primary text-white rounded-md font-semibold flex items-center justify-center min-w-[80px]">Crear</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal para Proyectos -->
        <div id="project-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-md transform transition-all opacity-0 -translate-y-10" role="dialog" aria-modal="true">
                <h3 class="text-2xl font-bold mb-6">Crear Nuevo Proyecto</h3>
                <form id="project-form">
                    <div class="mb-6">
                        <label for="project-name" class="block text-sm font-medium text-gray-400 mb-1">Nombre del proyecto</label>
                        <input type="text" id="project-name" class="w-full bg-theme/50 border border-theme rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-theme-primary text-gray-800 dark:text-purple-400" required>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-project-btn" class="px-4 py-2 rounded-md text-gray-400 hover:bg-gray-700">Cancelar</button>
                        <button type="submit" id="save-project-btn" class="px-6 py-2 bg-theme-primary text-white rounded-md font-semibold flex items-center justify-center min-w-[80px]">Crear</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para Tareas del Calendario -->
        <div id="calendar-day-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-md transform transition-all opacity-0 -translate-y-10" role="dialog" aria-modal="true">
                <h3 id="calendar-day-title" class="text-2xl font-bold mb-6">Tareas del día</h3>
                <div id="calendar-day-tasks" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Las tareas del día se insertarán aquí -->
                </div>
                 <div class="mt-6 flex justify-between items-center">
                    <button type="button" id="add-task-from-calendar-btn" class="px-4 py-2 bg-theme-secondary text-white rounded-md font-semibold">Añadir Tarea</button>
                    <button type="button" id="close-calendar-day-btn" class="px-6 py-2 bg-theme-primary text-white rounded-md font-semibold">Cerrar</button>
                </div>
            </div>
        </div>
        
        <!-- Modal de Confirmación -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-sm text-center transform transition-all opacity-0 -translate-y-10" role="alertdialog" aria-modal="true">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 id="confirm-title" class="text-lg font-medium leading-6"></h3>
                <div class="mt-2">
                    <p id="confirm-message" class="text-sm text-gray-400"></p>
                </div>
                <div class="mt-6 flex justify-center space-x-4">
                    <button type="button" id="cancel-confirm-btn" class="px-4 py-2 rounded-md text-gray-400 hover:bg-gray-700">Cancelar</button>
                    <button type="button" id="confirm-action-btn" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Información -->
        <div id="info-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-theme-card rounded-lg shadow-2xl p-8 w-full max-w-sm text-center transform transition-all opacity-0 -translate-y-10" role="alertdialog" aria-modal="true">
                <div id="info-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                    <!-- Icono dinámico aquí -->
                </div>
                <h3 id="info-title" class="text-lg font-medium leading-6"></h3>
                <div class="mt-2">
                    <p id="info-message" class="text-sm text-gray-400"></p>
                </div>
                <div class="mt-6">
                    <button type="button" id="close-info-btn" class="w-full px-6 py-2 bg-theme-primary text-white rounded-md font-semibold">Aceptar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    // =================================================================================
    // ORION APP - v2.4 (Unified Background & Fixes)
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
    
        // -----------------------------------------------------------------------------
        // A. ESTADO GLOBAL Y CONFIGURACIÓN
        // -----------------------------------------------------------------------------
        const AppState = {
            user: {
                name: 'Usuario',
                theme: 'dark',
                streak: 0,
                lastCompletionDate: null,
            },
            projects: [],
            tasks: [],
            filters: {
                search: '',
                projectId: 'all'
            },
            currentDate: new Date(),
            selectedCalendarDate: null,
        };
    
        // -----------------------------------------------------------------------------
        // B. SELECTORES DEL DOM
        // -----------------------------------------------------------------------------
        const DOM = {
            // Body
            body: document.body,
            // Canvas
            starfieldCanvas: document.getElementById('starfield-canvas'),
            // Pantallas
            welcomeScreen: document.getElementById('welcome-screen'),
            mainApp: document.getElementById('main-app'),
            slogan: document.getElementById('slogan'),
            startBtn: document.getElementById('start-btn'),
            mainTitle: document.getElementById('main-title'),
    
            // Navegación
            navButtons: document.querySelectorAll('.nav-btn'),
            mobileNavButtons: document.querySelectorAll('.mobile-nav-btn'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            mobileMenu: document.getElementById('mobile-menu'),
            closeMobileMenu: document.getElementById('close-mobile-menu'),
    
            // Secciones
            sections: document.querySelectorAll('.app-section'),
    
            // Dashboard
            userName: document.getElementById('user-name'),
            todayTasksList: document.getElementById('today-tasks-list'),
            upcomingTasksList: document.getElementById('upcoming-tasks-list'),
            streakCount: document.getElementById('streak-count'),
    
            // Tareas y Filtros
            createTaskBtn: document.getElementById('create-task-btn'),
            createProjectBtn: document.getElementById('create-project-btn'),
            quickSaveBtn: document.getElementById('quick-save-btn'),
            todoColumn: document.getElementById('todo-column'),
            doingColumn: document.getElementById('doing-column'),
            completedColumn: document.getElementById('completed-column'),
            searchTasksInput: document.getElementById('search-tasks-input'),
            projectFilterSelect: document.getElementById('project-filter-select'),
    
            // Calendario
            monthYearHeader: document.getElementById('month-year-header'),
            calendarGrid: document.getElementById('calendar-grid'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            gotoTodayBtn: document.getElementById('goto-today-btn'),
    
            // Kaizen
            tryKaizenBtn: document.getElementById('try-kaizen-btn'),
    
            // Configuración
            themeToggle: document.getElementById('theme-toggle'),
            usernameInput: document.getElementById('username-input'),
            exportJsonBtn: document.getElementById('export-json-btn'),
            importJsonInput: document.getElementById('import-json-input'),
            logoutBtn: document.getElementById('logout-btn'),
            deleteAllBtn: document.getElementById('delete-all-btn'),
    
            // Modales
            modalContainer: document.getElementById('modal-container'),
            // Modal de Tareas
            taskModal: {
                el: document.getElementById('task-modal'),
                content: document.getElementById('task-modal').querySelector('[role="dialog"]'),
                title: document.getElementById('modal-title'),
                form: document.getElementById('task-form'),
                idInput: document.getElementById('task-id'),
                nameInput: document.getElementById('task-name'),
                projectSelect: document.getElementById('task-project'),
                descriptionInput: document.getElementById('task-description'),
                dateInput: document.getElementById('task-date'),
                calendarCheckbox: document.getElementById('task-calendar-checkbox'),
                cancelBtn: document.getElementById('cancel-task-btn'),
                saveBtn: document.getElementById('save-task-btn'),
            },
            // Modal de Proyectos
            projectModal: {
                el: document.getElementById('project-modal'),
                content: document.getElementById('project-modal').querySelector('[role="dialog"]'),
                form: document.getElementById('project-form'),
                nameInput: document.getElementById('project-name'),
                cancelBtn: document.getElementById('cancel-project-btn'),
                saveBtn: document.getElementById('save-project-btn'),
            },
            // Modal de día del calendario
            calendarDayModal: {
                el: document.getElementById('calendar-day-modal'),
                content: document.getElementById('calendar-day-modal').querySelector('[role="dialog"]'),
                title: document.getElementById('calendar-day-title'),
                tasksContainer: document.getElementById('calendar-day-tasks'),
                closeBtn: document.getElementById('close-calendar-day-btn'),
                addTaskBtn: document.getElementById('add-task-from-calendar-btn'),
            },
            // Modal de Confirmación
            confirmModal: {
                el: document.getElementById('confirm-modal'),
                content: document.getElementById('confirm-modal').querySelector('[role="alertdialog"]'),
                title: document.getElementById('confirm-title'),
                message: document.getElementById('confirm-message'),
                cancelBtn: document.getElementById('cancel-confirm-btn'),
                confirmBtn: document.getElementById('confirm-action-btn'),
            },
            // Modal de Información
            infoModal: {
                el: document.getElementById('info-modal'),
                content: document.getElementById('info-modal').querySelector('[role="alertdialog"]'),
                title: document.getElementById('info-title'),
                message: document.getElementById('info-message'),
                closeBtn: document.getElementById('close-info-btn'),
                iconContainer: document.getElementById('info-icon-container'),
            },
        };
    
        // -----------------------------------------------------------------------------
        // C. LÓGICA DE DATOS (LocalStorage)
        // -----------------------------------------------------------------------------
        const DataService = {
            load() {
                const savedState = localStorage.getItem('orionAppState_v2');
                if (savedState) {
                    try {
                        const parsedState = JSON.parse(savedState);
                        Object.assign(AppState, parsedState);
                    } catch(e) {
                        console.error("Failed to parse state from localStorage:", e);
                        localStorage.removeItem('orionAppState_v2'); // Clear corrupted data
                    }
                }
                AppState.currentDate = new Date(); // Siempre resetear a la fecha actual al cargar
            },
            save() {
                localStorage.setItem('orionAppState_v2', JSON.stringify(AppState));
            }
        };
    
        // -----------------------------------------------------------------------------
        // D. RENDERIZADO Y MANIPULACIÓN DEL DOM
        // -----------------------------------------------------------------------------
        const UIManager = {
            // -- Renderizado principal y selectivo --
            renderDashboard() {
                DOM.userName.textContent = AppState.user.name || 'Usuario';
                
                const today = new Date().toDateString();
                const tasksToday = AppState.tasks.filter(t => t.date && new Date(t.date).toDateString() === today);
                
                const upcomingDate = new Date();
                upcomingDate.setDate(upcomingDate.getDate() + 5);
                const tasksUpcoming = AppState.tasks.filter(t => {
                    if (!t.date) return false;
                    const taskDate = new Date(t.date);
                    return taskDate.toDateString() !== today && taskDate > new Date() && taskDate <= upcomingDate;
                });

                DOM.todayTasksList.innerHTML = '';
                if (tasksToday.length > 0) {
                    tasksToday.forEach(task => DOM.todayTasksList.appendChild(this.createDashboardTaskItem(task)));
                } else {
                    DOM.todayTasksList.innerHTML = '<p class="text-gray-500 text-sm">No hay tareas para hoy. ¡Planifica algo o tómate un descanso!</p>';
                }

                DOM.upcomingTasksList.innerHTML = '';
                 if (tasksUpcoming.length > 0) {
                    tasksUpcoming.forEach(task => DOM.upcomingTasksList.appendChild(this.createDashboardTaskItem(task)));
                } else {
                    DOM.upcomingTasksList.innerHTML = '<p class="text-gray-500 text-sm">No hay tareas próximas en los siguientes 5 días.</p>';
                }
                
                DOM.streakCount.textContent = AppState.user.streak || 0;
                feather.replace();
            },
    
            renderTasks() {
                DOM.todoColumn.innerHTML = '';
                DOM.doingColumn.innerHTML = '';
                DOM.completedColumn.innerHTML = '';
                
                const { search, projectId } = AppState.filters;
                const filteredTasks = AppState.tasks.filter(task => {
                    const matchesSearch = task.name.toLowerCase().includes(search.toLowerCase());
                    const matchesProject = projectId === 'all' || task.projectId === projectId;
                    return matchesSearch && matchesProject;
                });
    
                const columns = {
                    todo: DOM.todoColumn,
                    doing: DOM.doingColumn,
                    completed: DOM.completedColumn,
                };
    
                if (filteredTasks.length === 0 && AppState.tasks.length > 0) {
                     DOM.todoColumn.appendChild(this.createEmptyStateCard("No hay tareas que coincidan con tu búsqueda."));
                } else if (AppState.tasks.length === 0) {
                    DOM.todoColumn.appendChild(this.createEmptyStateCard("Tu lienzo está listo. ¡Crea una tarea para empezar!"));
                } else {
                    filteredTasks.forEach(task => {
                        const taskCard = this.createTaskCard(task);
                        columns[task.status]?.appendChild(taskCard);
                    });
                }
                
                Object.values(columns).forEach(col => {
                    if (col.children.length === 0) {
                        col.appendChild(this.createEmptyStateCard("Arrastra una tarea aquí."));
                    }
                });

                feather.replace();
            },
    
            renderCalendar() {
                const grid = DOM.calendarGrid;
                while (grid.children.length > 7) {
                    grid.removeChild(grid.lastChild);
                }
    
                const date = AppState.currentDate;
                const year = date.getFullYear();
                const month = date.getMonth();
    
                DOM.monthYearHeader.textContent = `${date.toLocaleString('es-ES', { month: 'long' })} ${year}`.replace(/^\w/, c => c.toUpperCase());
    
                const firstDayOfMonth = new Date(year, month, 1);
                const firstDayOfWeek = firstDayOfMonth.getDay();
                const calendarStartDate = new Date(firstDayOfMonth);
                calendarStartDate.setDate(calendarStartDate.getDate() - firstDayOfWeek);
    
                for (let i = 0; i < 42; i++) {
                    const cellDate = new Date(calendarStartDate);
                    cellDate.setDate(cellDate.getDate() + i);
    
                    const dayCell = document.createElement('div');
                    dayCell.className = 'group relative text-center py-1 cursor-pointer transition-colors aspect-square flex items-center justify-center flex-col border-t border-l border-theme';
                    dayCell.dataset.date = cellDate.toISOString().split('T')[0];
    
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'day-number w-8 h-8 flex items-center justify-center rounded-full hover:bg-theme-card/50';
                    dayNumber.textContent = cellDate.getDate();
                    dayCell.appendChild(dayNumber);
    
                    // Estilos para días fuera del mes (Ghost Days)
                    if (cellDate.getMonth() !== month) {
                        dayCell.classList.add('opacity-40');
                    }
    
                    // Estilo para el día actual
                    const today = new Date();
                    if (cellDate.toDateString() === today.toDateString()) {
                        dayNumber.classList.add('border-2', 'border-theme-primary');
                    }
    
                    // Indicador de prioridad
                    const highestPriority = App.getHighestPriorityForDay(cellDate);
                    if (highestPriority) {
                        const priorityColors = { high: 'bg-red-500', medium: 'bg-yellow-500', low: 'bg-green-500' };
                        const dot = document.createElement('div');
                        dot.className = `absolute bottom-1.5 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full ${priorityColors[highestPriority]}`;
                        dayCell.appendChild(dot);
                    }
                    
                    grid.appendChild(dayCell);
                }
                feather.replace();
            },
    
            renderSettings() {
                DOM.usernameInput.value = AppState.user.name;
                this.applyTheme();
            },
            
            renderProjectFilters() {
                const select = DOM.projectFilterSelect;
                const taskProjectSelect = DOM.taskModal.projectSelect;
                const currentFilter = select.value;
                const currentTaskProject = taskProjectSelect.value;
                
                select.innerHTML = '<option value="all">Todos los proyectos</option>';
                taskProjectSelect.innerHTML = '<option value="none">Sin proyecto</option>';
    
                AppState.projects.forEach(p => {
                    const option = new Option(p.name, p.id);
                    select.add(option.cloneNode(true));
                    taskProjectSelect.add(option);
                });
                
                select.value = currentFilter;
                taskProjectSelect.value = currentTaskProject;
            },

            // -- Creación de elementos --
            createTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'task-card bg-theme-card p-3 rounded-lg shadow-md border-l-4 transition-all duration-300';
                card.dataset.id = task.id;
                
                const priorityStyles = {
                    low: { icon: 'chevrons-down', color: 'border-green-500', text: 'text-green-500' },
                    medium: { icon: 'minus', color: 'border-yellow-500', text: 'text-yellow-500' },
                    high: { icon: 'chevrons-up', color: 'border-red-500', text: 'text-red-500' }
                };
                const style = priorityStyles[task.priority] || priorityStyles.medium;
                card.classList.add(style.color);
    
                const projectName = AppState.projects.find(p => p.id === task.projectId)?.name;
    
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold pr-2">${task.name}</p>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <i data-feather="${style.icon}" class="w-4 h-4 ${style.text}"></i>
                            <button class="edit-task-btn text-gray-400 hover:text-white"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                            <button class="delete-task-btn text-gray-400 hover:text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">${task.description || ''}</p>
                    <div class="flex justify-between items-center mt-3 text-xs">
                        ${projectName ? `<span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full">${projectName}</span>` : '<span></span>'}
                        ${task.date ? `<span class="text-gray-500 flex items-center"><i data-feather="calendar" class="w-3 h-3 mr-1"></i> ${new Date(task.date).toLocaleDateString()}</span>` : ''}
                    </div>
                `;
                return card;
            },
            
            createEmptyStateCard(message) {
                const card = document.createElement('div');
                card.className = 'text-center text-sm text-gray-500 p-6 bg-theme-card/20 rounded-lg border-2 border-dashed border-theme';
                card.innerHTML = `<i data-feather="coffee" class="mx-auto mb-2"></i><p>${message}</p>`;
                return card;
            },

            createDashboardTaskItem(task) {
                const item = document.createElement('div');
                item.className = 'bg-theme-card/50 p-3 rounded-lg flex items-center justify-between border-b border-theme last:border-b-0';
                const priorityStyles = {
                    high: 'bg-red-500',
                    medium: 'bg-yellow-500',
                    low: 'bg-green-500',
                };
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">${task.name}</p>
                        <p class="text-xs text-gray-400">${new Date(task.date).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}</p>
                    </div>
                    <div class="w-2 h-2 rounded-full ${priorityStyles[task.priority] || 'bg-gray-500'}"></div>
                `;
                return item;
            },

            // -- Utilidades de UI --
            applyTheme() {
                const html = document.documentElement;
                if (AppState.user.theme === 'dark') {
                    html.classList.add('dark');
                    html.classList.remove('light');
                    DOM.themeToggle.checked = true;
                    DOM.body.classList.add('dark');
                    DOM.body.classList.remove('light');
                } else {
                    html.classList.add('light');
                    html.classList.remove('dark');
                    DOM.themeToggle.checked = false;
                    DOM.body.classList.add('light');
                    DOM.body.classList.remove('dark');
                }
            },
    
            setButtonLoading(button, isLoading) {
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.innerHTML;
                    button.innerHTML = '<span class="loader"></span>';
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText;
                }
            },
        };
    
        // -----------------------------------------------------------------------------
        // E. GESTOR DE MODALES Y ACCESIBILIDAD
        // -----------------------------------------------------------------------------
        const ModalManager = {
            _currentlyOpen: null,
            _focusableElements: 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
    
            open(modal) {
                this._currentlyOpen = modal;
                modal.el.classList.remove('hidden');
                setTimeout(() => {
                    modal.content.classList.remove('opacity-0', '-translate-y-10');
                    const firstFocusable = modal.content.querySelector(this._focusableElements);
                    if (firstFocusable) firstFocusable.focus();
                }, 10);
                document.addEventListener('keydown', this._handleKeydown);
            },
    
            close(modal) {
                this._currentlyOpen = null;
                modal.content.classList.add('opacity-0', '-translate-y-10');
                setTimeout(() => modal.el.classList.add('hidden'), 300);
                document.removeEventListener('keydown', this._handleKeydown);
            },
    
            _handleKeydown: (e) => {
                if (e.key === 'Escape' && ModalManager._currentlyOpen) {
                    ModalManager.close(ModalManager._currentlyOpen);
                }
                if (e.key === 'Tab' && ModalManager._currentlyOpen) {
                    const modal = ModalManager._currentlyOpen;
                    const focusableContent = Array.from(modal.content.querySelectorAll(ModalManager._focusableElements));
                    const firstFocusableElement = focusableContent[0];
                    const lastFocusableElement = focusableContent[focusableContent.length - 1];
    
                    if (e.shiftKey) { // Shift + Tab
                        if (document.activeElement === firstFocusableElement) {
                            lastFocusableElement.focus();
                            e.preventDefault();
                        }
                    } else { // Tab
                        if (document.activeElement === lastFocusableElement) {
                            firstFocusableElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            }
        };
    
        // -----------------------------------------------------------------------------
        // F. LÓGICA DE LA APLICACIÓN Y MANEJADORES DE EVENTOS
        // -----------------------------------------------------------------------------
        const App = {
            init() {
                DataService.load();
                this.setupEventListeners();
                UIManager.applyTheme();
                this.renderInitialUI();
                this.initWelcomeAnimation();
                this.initSortable();
                this.initStarfield();
                this.updateNotificationIndicator();
            },
    
            renderInitialUI() {
                UIManager.renderDashboard();
                UIManager.renderTasks();
                UIManager.renderCalendar();
                UIManager.renderSettings();
                UIManager.renderProjectFilters();
                feather.replace();
            },
    
            initWelcomeAnimation() {
                const title = "ORION";
                const sloganText = "Organiza. Evoluciona. Expande tu universo.";
                
                DOM.mainTitle.innerHTML = '';
                title.split('').forEach((letter, index) => {
                    const span = document.createElement('span');
                    span.textContent = letter;
                    span.style.animationDelay = `${index * 0.1}s`;
                    DOM.mainTitle.appendChild(span);
                });

                const totalTitleAnimationTime = title.length * 100 + 800;

                setTimeout(() => {
                    DOM.slogan.style.opacity = 1;
                    const textSpan = document.createElement('span');
                    const caretSpan = document.createElement('span');
                    caretSpan.className = 'typewriter-caret';
                    DOM.slogan.appendChild(textSpan);
                    DOM.slogan.appendChild(caretSpan);
                    
                    let i = 0;
                    function type() {
                        if (i < sloganText.length) {
                            textSpan.textContent += sloganText.charAt(i);
                            i++;
                            setTimeout(type, 50);
                        } else {
                             setTimeout(() => {
                                DOM.startBtn.style.opacity = 1;
                                DOM.welcomeScreen.querySelector('footer').style.opacity = 1;
                             }, 300);
                        }
                    }
                    type();
                }, totalTitleAnimationTime);
            },
    
            initSortable() {
                [DOM.todoColumn, DOM.doingColumn, DOM.completedColumn].forEach(col => {
                    new Sortable(col, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: (evt) => {
                            const taskId = evt.item.dataset.id;
                            const newStatus = evt.to.id.replace('-column', '');
                            const task = AppState.tasks.find(t => t.id === taskId);
                            if (task) {
                                task.status = newStatus;
                                if (newStatus === 'completed') {
                                    this.updateStreak();
                                }
                                DataService.save();
                                UIManager.renderDashboard();
                                UIManager.renderTasks();
                            }
                        }
                    });
                });
            },
            
            initStarfield() {
                const canvas = DOM.starfieldCanvas;
                const ctx = canvas.getContext('2d');
                let stars = [];
                let animationFrameId;
                let isPaused = false;

                function resizeCanvas() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    createStars();
                }

                function createStars() {
                    stars = [];
                    const starCount = Math.floor((canvas.width * canvas.height) / 5000); 
                    for (let i = 0; i < starCount; i++) {
                        stars.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height,
                            radius: Math.random() * 1.5 + 0.5,
                            alpha: Math.random() * 0.5 + 0.5,
                            alphaChange: (Math.random() - 0.5) * 0.01
                        });
                    }
                }

                function drawStars() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Fondo base
                    const bodyBg = getComputedStyle(document.body).getPropertyValue('background-color');
                    ctx.fillStyle = bodyBg;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Estrellas
                    ctx.fillStyle = AppState.user.theme === 'dark' ? 'rgba(224, 224, 224, 0.8)' : 'rgba(74, 74, 74, 0.6)';
                    
                    stars.forEach(star => {
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                        ctx.globalAlpha = star.alpha;
                        ctx.fill();
                    });
                    ctx.globalAlpha = 1;
                }

                function updateStars() {
                    stars.forEach(star => {
                        star.alpha += star.alphaChange;
                        if (star.alpha <= 0.1 || star.alpha >= 1) {
                            star.alphaChange *= -1;
                        }
                    });
                }

                function animate() {
                    if (isPaused) return;
                    updateStars();
                    drawStars();
                    animationFrameId = requestAnimationFrame(animate);
                }
                
                window.addEventListener('resize', resizeCanvas);
                document.addEventListener('visibilitychange', () => {
                    isPaused = document.hidden;
                    if (!isPaused) {
                        animate();
                    }
                });

                resizeCanvas();
                animate();
            },
    
            // -- Manejadores de eventos --
            setupEventListeners() {
                // Navegación
                DOM.startBtn.addEventListener('click', () => {
                    DOM.welcomeScreen.classList.add('opacity-0');
                    setTimeout(() => {
                        DOM.welcomeScreen.classList.add('hidden');
                        DOM.mainApp.classList.remove('hidden');
                        setTimeout(() => DOM.mainApp.classList.remove('opacity-0'), 50);
                    }, 1000);
                });
    
                const navigate = (sectionId) => {
                    DOM.sections.forEach(s => s.classList.add('hidden'));
                    document.getElementById(sectionId).classList.remove('hidden');
                    
                    [...DOM.navButtons, ...DOM.mobileNavButtons].forEach(btn => {
                        btn.classList.toggle('bg-theme-primary', btn.dataset.section === sectionId);
                        btn.classList.toggle('text-white', btn.dataset.section === sectionId);
                    });
                    DOM.mobileMenu.classList.add('hidden');

                    if (sectionId === 'dashboard') {
                        this.updateNotificationIndicator(false); // Remove notification on visit
                    }
                };
                DOM.navButtons.forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.section)));
                DOM.mobileNavButtons.forEach(btn => btn.addEventListener('click', () => navigate(btn.dataset.section)));
                DOM.hamburgerBtn.addEventListener('click', () => DOM.mobileMenu.classList.remove('hidden'));
                DOM.closeMobileMenu.addEventListener('click', () => DOM.mobileMenu.classList.add('hidden'));
    
                // Tareas y Proyectos
                DOM.createTaskBtn.addEventListener('click', () => this.openTaskModal());
                DOM.createProjectBtn.addEventListener('click', () => ModalManager.open(DOM.projectModal));
                DOM.quickSaveBtn.addEventListener('click', () => this.exportData());
                DOM.taskModal.form.addEventListener('submit', (e) => this.handleTaskFormSubmit(e));
                DOM.projectModal.form.addEventListener('submit', (e) => this.handleProjectFormSubmit(e));
                document.getElementById('tasks').addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-task-btn');
                    const deleteBtn = e.target.closest('.delete-task-btn');
                    if (editBtn) this.openTaskModal(editBtn.closest('.task-card').dataset.id);
                    if (deleteBtn) this.handleDeleteTask(deleteBtn.closest('.task-card').dataset.id);
                });
    
                // Filtros
                DOM.searchTasksInput.addEventListener('input', (e) => {
                    AppState.filters.search = e.target.value;
                    UIManager.renderTasks();
                });
                DOM.projectFilterSelect.addEventListener('change', (e) => {
                    AppState.filters.projectId = e.target.value;
                    UIManager.renderTasks();
                });
    
                // Calendario
                DOM.prevMonthBtn.addEventListener('click', () => { AppState.currentDate.setMonth(AppState.currentDate.getMonth() - 1); UIManager.renderCalendar(); });
                DOM.nextMonthBtn.addEventListener('click', () => { AppState.currentDate.setMonth(AppState.currentDate.getMonth() + 1); UIManager.renderCalendar(); });
                DOM.gotoTodayBtn.addEventListener('click', () => { AppState.currentDate = new Date(); UIManager.renderCalendar(); });
                DOM.calendarGrid.addEventListener('click', (e) => {
                    const dayCell = e.target.closest('[data-date]');
                    if (!dayCell) return;

                    if (e.target.classList.contains('day-number')) {
                        this.openCalendarDayModal(dayCell.dataset.date);
                    } else {
                        this.openTaskModal(null, dayCell.dataset.date);
                    }
                });
    
                // Kaizen
                DOM.tryKaizenBtn.addEventListener('click', () => {
                    navigate('tasks');
                    setTimeout(() => {
                        this.openTaskModal(null, null, true); // Pass a flag for Kaizen
                    }, 100);
                });
    
                // Configuración
                DOM.themeToggle.addEventListener('change', () => { AppState.user.theme = DOM.themeToggle.checked ? 'dark' : 'light'; UIManager.applyTheme(); DataService.save(); });
                DOM.usernameInput.addEventListener('change', () => { AppState.user.name = DOM.usernameInput.value; DataService.save(); UIManager.renderDashboard(); });
                DOM.exportJsonBtn.addEventListener('click', () => this.exportData());
                DOM.importJsonInput.addEventListener('change', (e) => this.importData(e));
                DOM.deleteAllBtn.addEventListener('click', () => this.deleteAllData());
                DOM.logoutBtn.addEventListener('click', () => this.logout());
    
                // Modales
                DOM.taskModal.cancelBtn.addEventListener('click', () => ModalManager.close(DOM.taskModal));
                DOM.projectModal.cancelBtn.addEventListener('click', () => ModalManager.close(DOM.projectModal));
                DOM.calendarDayModal.closeBtn.addEventListener('click', () => ModalManager.close(DOM.calendarDayModal));
                DOM.calendarDayModal.addTaskBtn.addEventListener('click', () => {
                    ModalManager.close(DOM.calendarDayModal);
                    this.openTaskModal(null, AppState.selectedCalendarDate);
                });
                DOM.confirmModal.cancelBtn.addEventListener('click', () => ModalManager.close(DOM.confirmModal));
                DOM.infoModal.closeBtn.addEventListener('click', () => ModalManager.close(DOM.infoModal));
            },
    
            // -- Lógica de acciones --
            openTaskModal(taskId = null, dateString = null, isKaizen = false) {
                const modal = DOM.taskModal;
                modal.form.reset();
                UIManager.renderProjectFilters();
    
                // Reset placeholders
                modal.nameInput.placeholder = '';
                modal.descriptionInput.placeholder = '';
    
                if (isKaizen) {
                    modal.nameInput.placeholder = "Mi primera microacción";
                    modal.descriptionInput.placeholder = "Ej: Leer una página de un libro.";
                }
    
                if (taskId) {
                    const task = AppState.tasks.find(t => t.id === taskId);
                    modal.title.textContent = 'Editar Tarea';
                    modal.saveBtn.textContent = 'Guardar';
                    modal.idInput.value = task.id;
                    modal.nameInput.value = task.name;
                    modal.projectSelect.value = task.projectId || 'none';
                    modal.descriptionInput.value = task.description;
                    modal.dateInput.value = task.date ? task.date.split('T')[0] : '';
                    modal.calendarCheckbox.checked = task.addToCalendar;
                    modal.form.querySelector(`input[name="priority"][value="${task.priority}"]`).checked = true;
                } else {
                    modal.title.textContent = 'Crear Nueva Tarea';
                    modal.saveBtn.textContent = 'Crear';
                    modal.idInput.value = '';
                    modal.form.querySelector('input[name="priority"][value="medium"]').checked = true;
                    if (dateString) {
                        modal.dateInput.value = dateString;
                        modal.calendarCheckbox.checked = true;
                    }
                }
                ModalManager.open(modal);
            },
    
            handleTaskFormSubmit(e) {
                e.preventDefault();
                const modal = DOM.taskModal;
                UIManager.setButtonLoading(modal.saveBtn, true);
    
                setTimeout(() => {
                    const id = modal.idInput.value;
                    const taskData = {
                        id: id || `task-${Date.now()}`,
                        name: modal.nameInput.value,
                        description: modal.descriptionInput.value,
                        date: modal.dateInput.value ? new Date(modal.dateInput.value + 'T00:00:00').toISOString() : null,
                        addToCalendar: modal.calendarCheckbox.checked,
                        projectId: modal.projectSelect.value === 'none' ? null : modal.projectSelect.value,
                        priority: modal.form.querySelector('input[name="priority"]:checked').value,
                    };
    
                    if (id) {
                        const taskIndex = AppState.tasks.findIndex(t => t.id === id);
                        AppState.tasks[taskIndex] = { ...AppState.tasks[taskIndex], ...taskData };
                    } else {
                        taskData.status = 'todo';
                        AppState.tasks.push(taskData);
                    }
                    
                    DataService.save();
                    UIManager.renderTasks();
                    UIManager.renderDashboard();
                    UIManager.renderCalendar();
                    this.updateNotificationIndicator();
                    UIManager.setButtonLoading(modal.saveBtn, false);
                    ModalManager.close(modal);
                }, 300);
            },
    
            handleDeleteTask(taskId) {
                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = 'Eliminar Tarea';
                DOM.confirmModal.message.textContent = '¿Estás seguro? Esta acción no se puede deshacer.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', () => {
                    AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
                    DataService.save();
                    UIManager.renderTasks();
                    UIManager.renderDashboard();
                    UIManager.renderCalendar();
                    this.updateNotificationIndicator();
                    ModalManager.close(DOM.confirmModal);
                }, { once: true });
            },
    
            handleProjectFormSubmit(e) {
                e.preventDefault();
                const modal = DOM.projectModal;
                UIManager.setButtonLoading(modal.saveBtn, true);
    
                setTimeout(() => {
                    const newProject = {
                        id: `proj-${Date.now()}`,
                        name: modal.nameInput.value,
                    };
                    AppState.projects.push(newProject);
                    DataService.save();
                    UIManager.renderProjectFilters();
                    UIManager.setButtonLoading(modal.saveBtn, false);
                    ModalManager.close(modal);
                }, 300);
            },
            
            openCalendarDayModal(dateString) {
                AppState.selectedCalendarDate = dateString;
                const date = new Date(dateString + 'T00:00:00');
                const modal = DOM.calendarDayModal;
                
                modal.title.textContent = `Tareas para ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}`;
                
                const tasksForDay = AppState.tasks.filter(t => t.date && new Date(t.date).toDateString() === date.toDateString());
                
                modal.tasksContainer.innerHTML = '';
                if (tasksForDay.length > 0) {
                    tasksForDay.forEach(task => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'bg-theme/50 p-3 rounded-md text-left';
                        taskEl.textContent = task.name;
                        modal.tasksContainer.appendChild(taskEl);
                    });
                } else {
                    modal.tasksContainer.innerHTML = '<p class="text-gray-500">No hay tareas programadas para este día.</p>';
                }
                
                ModalManager.open(modal);
            },
    
            getHighestPriorityForDay(date) {
                const tasksForDay = AppState.tasks.filter(t => t.date && new Date(t.date).toDateString() === date.toDateString());
                if (tasksForDay.length === 0) return null;
                if (tasksForDay.some(t => t.priority === 'high')) return 'high';
                if (tasksForDay.some(t => t.priority === 'medium')) return 'medium';
                return 'low';
            },
    
            exportData() {
                const now = new Date();
                const pad = (num) => num.toString().padStart(2, '0');
                const dateStamp = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}`;
                const timeStamp = `${pad(now.getHours())}${pad(now.getMinutes())}`;
                const fileName = `orion_backup_${dateStamp}-${timeStamp}.json`;

                const dataStr = JSON.stringify(AppState, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', fileName);
                linkElement.click();
            },
    
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        // Validación más robusta
                        if (importedState && typeof importedState.user === 'object' && Array.isArray(importedState.tasks) && Array.isArray(importedState.projects) && typeof importedState.filters === 'object') {
                            Object.assign(AppState, importedState);
                            AppState.currentDate = new Date(); // Resetear siempre la fecha actual
                            DataService.save();
                            this.renderInitialUI();
                            this.openInfoModal({ title: 'Éxito', message: '¡Datos importados correctamente!', type: 'success' });
                        } else {
                             this.openInfoModal({ title: 'Error de Formato', message: 'El archivo no parece ser un backup válido de ORION.', type: 'error' });
                        }
                    } catch (error) {
                        this.openInfoModal({ title: 'Error de Archivo', message: `No se pudo leer el archivo JSON. (${error.message})`, type: 'error' });
                    }
                };
                reader.readAsText(file);
                DOM.importJsonInput.value = '';
            },
    
            deleteAllData() {
                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = 'Borrar todos los datos';
                DOM.confirmModal.message.textContent = '¡Atención! Esto eliminará permanentemente todas tus tareas y proyectos.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', () => {
                    localStorage.removeItem('orionAppState_v2');
                    window.location.reload(); // La forma más sencilla de resetear todo a su estado inicial
                }, { once: true });
            },
    
            logout() {
                ModalManager.open(DOM.confirmModal);
                DOM.confirmModal.title.textContent = 'Cerrar Sesión';
                DOM.confirmModal.message.textContent = 'Esto te redirigirá a la pantalla de bienvenida. Tus datos se guardarán.';
                
                const newConfirmBtn = DOM.confirmModal.confirmBtn.cloneNode(true);
                DOM.confirmModal.confirmBtn.parentNode.replaceChild(newConfirmBtn, DOM.confirmModal.confirmBtn);
                DOM.confirmModal.confirmBtn = newConfirmBtn;
    
                DOM.confirmModal.confirmBtn.addEventListener('click', () => {
                    window.location.reload();
                }, { once: true });
            },

            openInfoModal({ title, message, type = 'info' }) {
                const modal = DOM.infoModal;
                modal.title.textContent = title;
                modal.message.textContent = message;
    
                modal.iconContainer.innerHTML = '';
                modal.iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4';
    
                if (type === 'error') {
                    modal.iconContainer.classList.add('bg-red-100');
                    modal.iconContainer.innerHTML = `<i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>`;
                } else { // 'success' or 'info'
                    modal.iconContainer.classList.add('bg-green-100');
                    modal.iconContainer.innerHTML = `<i data-feather="check-circle" class="h-6 w-6 text-green-600"></i>`;
                }
                feather.replace();
                ModalManager.open(modal);
            },

            updateStreak() {
                const today = new Date().toDateString();
                if (AppState.user.lastCompletionDate === today) {
                    return; // Ya se completó una tarea hoy
                }

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (AppState.user.lastCompletionDate === yesterday.toDateString()) {
                    AppState.user.streak = (AppState.user.streak || 0) + 1;
                } else {
                    AppState.user.streak = 1;
                }
                AppState.user.lastCompletionDate = today;
            },

            updateNotificationIndicator(show = true) {
                const today = new Date().toDateString();
                const tasksToday = AppState.tasks.filter(t => t.date && new Date(t.date).toDateString() === today && t.status !== 'completed');
                
                const shouldShow = show && tasksToday.length > 0;

                [...DOM.navButtons, ...DOM.mobileNavButtons].forEach(btn => {
                    if (btn.dataset.section === 'dashboard') {
                        let dot = btn.querySelector('.notification-dot');
                        if (shouldShow && !dot) {
                            dot = document.createElement('span');
                            dot.className = 'notification-dot';
                            btn.appendChild(dot);
                        } else if (!shouldShow && dot) {
                            dot.remove();
                        }
                    }
                });
            }
        };
    
        // Iniciar la aplicación
        App.init();
    });
    </script>
</body>
</html>
